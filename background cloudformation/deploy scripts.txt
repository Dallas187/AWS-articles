
#>>>>>>>>>>>>>>>>> Run code below during deploy to deploy the files out of the zip file from the bucket
#using appcmd rather than nice powershell commands, because the pwoershell commands require
#the module 'WebAdministration' to be loaded.


# Must be done once
Add-Type -Assembly "System.IO.Compression.FileSystem" ;


# -----------------------------------
# Assuming that 0.1500.zip is in temp dir
$zipFile = $env:temp + '\0.1500.zip'
$tempDir = $env:temp + '\' + [system.guid]::newguid().tostring()

[System.IO.Compression.ZipFile]::ExtractToDirectory($zipFile, $tempDir) ;

# -----------------------
# aws does above for you

# Unzip all .zip files. The resulting directories sit in the same directory as the zip file.
# Note that this is not recurrrent. 
get-childitem $tempDir -recurse -force | ?{$_.extension -eq ".zip"} | 
    ForEach-Object { [System.IO.Compression.ZipFile]::ExtractToDirectory($_.FullName, $_.FullName + '_dir') }
# >>>>>>>>>>>>>>>>>> no longer needed

	

# Run all deploy.ps1 files
$executionPolicy = Get-ExecutionPolicy
Set-ExecutionPolicy Bypass -Scope Process -force
get-childitem $tempDir -recurse -force | ?{$_.name -eq "deploy.ps1"} | 
	ForEach-Object { Invoke-Expression "$($_.FullName) -version 'vvvvv' -dbServer 'sssss' -dbUsername 'uuuuuu' -dbPassword 'ppppp'" }
Set-ExecutionPolicy $executionPolicy -Scope Process -force

# Ensure that current dir is not $tempDir, to prevent locking problems
# cd $env:temp

# Clean up the zip file and the expanded directory
Remove-Item $zipFile
Get-ChildItem $tempDir -Recurse | Remove-Item -force -Recurse

