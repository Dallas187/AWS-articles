<ul class="download">
<li><a href="https://github.com/mperdeck/AWS-articles/tree/master/4" target="_blank">Download templates, scripts, sample app</a></li>
</ul>

<a id="introduction"></a><h2>Introduction</h2>
<p>
    This is part 4 of a 
    <a href="http://www.codeproject.com/search.aspx?q=amazon+web+services+perdeck&x=0&y=0&sbo=kw" target="_blank">series of articles</a>
     about deploying your site to 
    <a href="http://aws.amazon.com/" target="_blank">Amazon Web Services</a> (AWS), 
    Amazon's counterpart to <a href="http://azure.microsoft.com/en-us/" target="_blank">Windows Azure</a>.
</p>
<p>
    In parts 1, 2 and 3, you saw how to use 
    the AWS service
                <a href="http://aws.amazon.com/elasticbeanstalk/" target="_blank">Elastic Beanstalk</a> to
    deploy a load balanced IIS based web site with a SQL Server database and its own domain name.
    This involved defining your EC2 servers, database server, etc. by completing a series of menus.
</p>

<ul>
<li><a href="#whycloudformation">Why CloudFormation</a></li>
<li><a href="#aboutthisarticle">About this article</a></li>
<li><a href="#solution-goals">Goals for this solution</a></li>
<li><a href="#solutioncomponents">Solution Components</a></li>
<li><a href="#costs">Costs</a></li>
<li><a href="#installation">Detailed installation steps</a></li>
<li><a href="#implementation">Implementation notes</a></li>
<li><a href="#nextparts">Next Parts</a></li>
</ul>



<a id="whycloudformation"></a><h2>Why CloudFormation</h2>
<p>
    Once your environment becomes a big more complicated,
    you'll quickly run into some drawbacks with this method:
</p>
<ul>
    <li>
        <b>Repeatabality</b> -
        You or a co-worker needs a carbon copy of your infrastructure in some other region.
        Or you need a test environment that is the same as your live environment.
        With menus, you're reduced to writing down every step and manually creating the copy.
<p />
    </li>
<li>
    <b>Source control</b> - 
    There is no system to track changes by you or your co-workers.
    No rolling back if you make a mistake.
<p />
</li>
<li>
    <b>Documentation</b> -
    To find out what's in an environment you have to hunt around the AWS dashboards.
<p />
</li>

</ul>
<p>
    The solution is to express your environment in a text file.
    This is easy to store, give to others and source control.
</p>
<p>
The AWS service
        <a href="http://aws.amazon.com/cloudformation/" target="_blank">CloudFormation</a>
    lets you do exactly that. You define everything as a single large JSON object in a <i>template</i> file.
    CloudFormation takes that file and creates all the servers, load balancers, etc. you specified.
This environment is called a <i>stack</i>.
</p>
<p>
  When it comes time to modify your stack - remove/add servers, upgrade/downgrade servers, etc. -
    you change your template and invoke CloudFormation again. It will figure out how to modify your existing stack
    to your desired new stack making the fewest changes and causing the least disruption. 
</p>
<p>Stacks have their own name, such as &quot;Test&quot; or &quot;Live&quot;. You can have multiple stacks
    and manage them independently. If you want 2 identical stacks, you'd use the same template to create them both.
</p>
<p>
    In addition to infrastructure, CloudFormation
    will also deploy software for you, such as a web application.
</p>

<a id="aboutthisarticle"></a><h2>About this article</h2>

<p>
    CloudFormation is a low level tool.
    Whereas Elastic Beanstalk takes care of lots of details such as creating the right security groups,
    you have to define all this in your template. There are many details to get right - and many ways
    to get it wrong. I found that the learning curve can be quite steep.
</p>
<p>
    When I set out to create an MVC web site with SQL Server using CloudFormation, I found that:
</p>
<ul>
    <li>
        To even get something simple working required getting many bits in place;
    </li>
    <li>
    The AWS documentation is extensive, but it only gets you 90% there.
You still have to figure many things out on your own.
    </li>
    <li>
        Although AWS and others provide sample code,
        this was too simple or sketchy for my purposes.
    </li>
</ul>

<p>
    So I'm publishing the fully fledged working solution here that I arrived at.
    You should be able to use this as is for your own web application, or use it as a basis for your own solution.
</p>
<p>
    Note that this is not a introduction to CloudFormation or AWS.
    The focus of this article is on describing the solution I came up with.
    However, it has many links to relevant parts of the AWS documentation
    to get all the details. This is not too hard and you'll learn a lot.
</p>

<a id="solution-goals"></a><h2>Goals for this solution</h2>

<p>
    The solution described in this article
     sets out to achieve 2 goals: to deploy certain 
    infrastructure
    and to 
    <a href="#solution-goal-software">deploy a web application and its updates</a>.
</p>


<a id="infrastructuregoal"></a>
<h3>Infrastructure Goal</h3>


<p>
    The infrastructure goal was to deploy a web site that uses a database and that has its own domain:
</p>
<img src="cfarchitecture.png" width="500" />

<p>
    Lets start from the center of the picture:
</p>
<ul>
    <li>
        <b>Web servers on EC2 instances</b> -
        The web site will run on one or more <a href="http://aws.amazon.com/ec2/" target="_blank">EC2 instances</a> - virtual machines in the AWS cloud
        acting as web servers.
        <p />
    </li>
    <li>
        <b>SQL Server database server</b> -
        The web sites access a SQL Server database hosted on an 
        <a href="http://aws.amazon.com/rds/" target="_blank">RDS</a> (Relational Database Service) instance. 
        RDS is a fully managed database server as a service with automatic 
        backups, etc. 
        <p />
    </li>
    <li>
        <b>SQL Server standby</b> -
        For enhanced  availability, you can 
        use a 
        <a href="http://aws.amazon.com/rds/details/multi-az/" target="_blank">Multi-AZ deployment</a>
        where a standby database server automatically takes over when the main database server fails
        (<a href="http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_SQLServer.html#SQLServer.Concepts.General.Mirroring" target="_blank"
            >only available</a>
         in the US East (N. Virginia), US West (Oregon), and EU (Ireland) regions).
        <p>
        Although reasonably priced for a company, this feature is probably too expensive for a personal site.
        So I created both a CloudFormation 
                <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/Template%20with%20SQL%20Server%20Express/Ec2RdsRoute54.template"
            target="_blank">template without a standy</a>
         and 
        a 
        <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/Template%20with%20SQL%20Server%20Standard%20and%20Multi%20AZ%20deployment/Ec2RdsRoute54.template"
            target="_blank">template with a standby</a>.
        </p>
    </li>
    <li>
        <b>Auto Scaling Group</b> -
        The <a href="http://aws.amazon.com/autoscaling/" target="_blank">auto scaling group</a> starts more EC2 instances when the existing
        instances get overloaded, and terminates instances when there is little to do. 
        <p />
    </li>
    <li>
        <b>Code package stored in S3 bucket</b> -
        Seeing that the auto scaling group starts and terminates EC2 instances at will, there is no point in deploying software to
        individual servers. Instead, a package file with the code making up the web application is stored in an 
        <a href="http://aws.amazon.com/s3/" target="_blank">S3</a> bucket (the S3 service lets you store files in the cloud).
        When the auto scaling group starts a new EC2 instance, it retrieves the package from the S3 bucket and installs it on the new instance. 
        <p />
    </li>
    <li>
        <b>Load Balancer</b> -
        The <a href="http://aws.amazon.com/elasticloadbalancing/" target="_blank">ELB</a> (Elastic Load Balancer)
        receives web requests from the Internet and parcels them out to the available web servers.
        <p />
    </li>
    <li>
        <a id="infrastructuregoal-route53"></a>
        <b>DNS Name Servers</b> -
        Used to translate your domain name to the IP address of the load balancer.
       Provided by the <a href="http://aws.amazon.com/route53/" target="_blank">Route 53</a> service.
    </li>
</ul>

<a id="solution-goal-software"></a>
<h3>Software deployment goal</h3>
<p>
    The solution also achieves some software deployment related goals:
    </p>
<ul>
    <li>
<b>Packaging</b>
-        Packages up an ASP.NET web project
        and store the packet in an S3 bucket.
        <p />
    </li>
    <li>
<b>Deployment</b> - 
        Installs IIS, etc. on new EC2 instances with a Deploy.ps1 script.
        <p />
    </li>
    <li>
<b>Version tags</b> -
        Adds tags with the current software version to the EC2 instances, 
        to make it easy to see what version a particular instance is running.
        <p />
    </li>
    <li>
<b>Terminate and Replace</b> -
        EC2 instances are never updated with new software versions.
        Instead, instances running old software are terminated and new EC2 instances created with the new software.
        This ensures that all EC2 instances are in the same known state, and that they all have the latest Windows patches.
        <p />
    </li>
    <li>
<b>Rolling updates</b> -
        EC2 instances are replaced one by one, so there are always instances running to serve requests.
        If there is only one EC2 instance, a temporary second instance is created.
        <p />
    </li>
    <li>
        <b>Web.config updated</b>
        -
        During deployment, the web.config file is updated with the version number, and the server name, user name and user password of the database server.
    </li>
</ul>

<p>
    I didn't look into database schema updates.
    If you use
    <a href="https://msdn.microsoft.com/en-au/data/jj193542.aspx" target="_blank">Entity Framework Code First</a>,
    the web application itself will update the schema for you.
    However, I appreciate more work would be needed if you can't use Entity Framework or Code First.
</p>


<a id="solutioncomponents"></a><h2>Solution Components</h2>
<p>
    The solution consists of a number of templates, scripts, etc., 
    which are in the 
    <a href="https://github.com/mperdeck/AWS-articles/tree/master/4" target="_blank">downloads</a>.
The
    <a href="#installation">next section</a>
shows how to use those components.
</p>

<ul>
    <li><a id="solutioncomponents-template-nofailover"></a>
        <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/Template%20with%20SQL%20Server%20Express/Ec2RdsRoute54.template"
            target="_blank">CloudFormation template without database server standby</a> 
        that specifies the infrastructure without the database server standby.
        <p />
    </li>
    <li>
        <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/Template%20with%20SQL%20Server%20Standard%20and%20Multi%20AZ%20deployment/Ec2RdsRoute54.template"
            target="_blank">CloudFormation template with database server standby</a> that 
         specifies the infrastructure with the database server standby.
        <p />
    </li>
    <li>
        <a href="https://github.com/mperdeck/AWS-articles/tree/master/4/Downloads/SimpleSiteWithDb" target="_blank">Very simple sample web site</a>
        that uses a database. You may want to use this to experiment before moving to something more complicated.
        <p>
            If you have a look at its web.config file, you'll find that it has a web.release.config transform
            to generate the Release version. That Release version has the placeholders
            <i>{{DbUsername}}</i>,
            <i>{{DbPassword}}</i>,
            <i>{{DbServer}}</i> and
            <i>{{Version}}</i>.
During deployment these will be replaced by the actual database server details and the software version. 
          </p>
    </li>
    <li>
        <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/SimpleSiteWithDb/SimpleSiteWithDb/Deploy.ps1" target="_blank"
            >Deploy.ps1</a> PowerShell script.
        <ul>
            <li>
                After a new web server is created by the auto scaling group, any Deploy.ps1 script inside the source tree of your web site is executed 
                on the new webserver by the CloudFormation template. 
            </li>
            <li>
                However, this particular Deploy.ps1 file is a bit more restrictive as to where it sits. 
                It has to sit in the root directory of the web application, where the main web.config is located.
            </li>
            <li>
                Receives software version, database server details, etc. via parameters.
            </li>
            <li>
                Responsible for starting IIS, replacing placeholders in the web.config, etc.
            </li>
        </ul>
        <p />
    </li>
   <li>
       <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/publish.ps1" target="_blank">Publish.ps1</a>
       PowerShell script that packages up your web application, stores it in an S3 bucket and calls the CloudFormation service
      with a template
        to deploy the infrastructure and web application. Also updates an existing stack. 
        <p />
   </li>
   <li>
       <a id="solutioncomponents-stackpolicy"></a>
       <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/stackpolicy.txt" target="_blank">Stack policy</a>
       that determines what servers can be replaced during an update.
       Use this to prevent CloudFormation from for example replacing a database server
       (<a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" target="_blank">more about stack policies</a>).
        <p />
   </li>
   <li>
       <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/user%20policy.txt" target="_blank">User policy</a>
       that provides the Publish.ps1 script all the permissions it needs to spin up the infrastructure.
   </li>
</ul>

<a id="costs"></a><h2>Costs</h2>
<p>
    Using AWS services is not free. This section is to spell this out.
    Personally, I found the amounts involved to be tiny,
    except for Multi-AZ deployments - do not leave these running overnight.
</p>
<table style=" border: 1px solid black;  border-spacing: 0px;   border-collapse:collapse">
    <tr>
        <th style="padding: 5px; border: 1px solid black;">
            Pricing Page
        </th>
        <th style="padding: 5px; border: 1px solid black;">
            Service is used for
        </th>
    </tr>
    <tr>
        <td style="padding: 5px; border: 1px solid black;">
            <a href="http://aws.amazon.com/cloudformation/pricing/" target="_blank">CloudFormation</a>
        </td>
        <td style="padding: 5px; border: 1px solid black;">
            Deployment configuration
        </td>
    </tr>
    <tr>
        <td style="padding: 5px; border: 1px solid black;">
            <a href="http://aws.amazon.com/ec2/pricing/" target="_blank">EC2 t2.micro instances</a>
        </td>
        <td style="padding: 5px; border: 1px solid black;">
            Virtual machines running web servers
        </td>
    </tr>
    <tr>
        <td style="padding: 5px; border: 1px solid black;">
            <a href="http://aws.amazon.com/elasticloadbalancing/pricing/" target="_blank">Elastic Load Balancing</a>
        </td>
        <td style="padding: 5px; border: 1px solid black;">
            Load balancer
        </td>
    </tr>
    <tr>
        <td style="padding: 5px; border: 1px solid black;">
            <a href="http://aws.amazon.com/autoscaling/pricing/" target="_blank">Auto Scaling</a>
        </td>
        <td style="padding: 5px; border: 1px solid black;">
            Spinning up/down web servers in response to traffic load
        </td>
    </tr>
    <tr>
        <td style="padding: 5px; border: 1px solid black;">
            <a href="http://aws.amazon.com/route53/pricing/" target="_blank">Route53</a>
        </td>
        <td style="padding: 5px; border: 1px solid black;">
            DNS name servers
        </td>
    </tr>
    <tr>
        <td style="padding: 5px; border: 1px solid black;">
            <a href="http://aws.amazon.com/s3/pricing/" target="_blank">S3</a>
        </td>
        <td style="padding: 5px; border: 1px solid black;">
            Storing software packages
        </td>
    </tr>
    <tr>
        <td style="padding: 5px; border: 1px solid black;">
            <a href="http://aws.amazon.com/rds/pricing/" target="_blank">RDS</a>,
            <a href="http://aws.amazon.com/rds/sqlserver/pricing/" target="_blank">SQL Server licence</a>
        </td>
        <td style="padding: 5px; border: 1px solid black;">
            Database server (see below)
        </td>
    </tr>
</table>
<h3>
    Some useful tools
</h3><ul>
    <li>
        <a href="http://calculator.s3.amazonaws.com/index.html" target="_blank">Simple Monthly Calculator</a>
    </li>
    <li>
        <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_EstimateTemplateCost.html" target="_blank">Estimate Template Cost</a>
    </li>
    <li>
        <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-paying.html" 
            target="_blank">Estimating the Cost of Your AWS CloudFormation Stack</a> (once your stack is running)
    </li>

</ul>

<h3>Multi-AZ deployment</h3>

<p>
    Multi-AZ deployments are much more expensive than a database server without standby.
</p>
<p>
    Amazon have implemented fail over for SQL Server servers using
    the 
    <a href="https://msdn.microsoft.com/en-us/library/ms189852.aspx" target="_blank">SQL Server Mirroring feature</a>. This feature is 
    <a href="https://msdn.microsoft.com/en-us/library/cc645993.aspx" target="_blank">not available</a>
     on SQL Server Express.
</p>
<p>
    As of March 2015, Your cheapest option that supports mirroring would be a SQL Server Standard Edition database
    on a db.m1.small instance
    (<a href="http://aws.amazon.com/rds/previous-generation/" target="_blank">pricing</a>).
</p><p>
    Keep in mind that AWS will charge you for the SQL Server Standard Edition licence, while a SQL Server Express licence is free.
</p><p>
    Also, you'll be paying for 2 database servers - the main server and the standby.
</p><p>
    If you're just playing around,
    I wouldn't keep a Multi-AZ deployment running overnight.
</p>

<a id="installation"></a><h2>Detailed installation steps</h2>

<p>
    This section shows how to spin up the infrastructure
    plus deploy a web application. First we need to get some once-off preliminaries out of the way, and then
    we can run the Publish.ps1 script to create the stack. You can use the same script to update your stack later on.
</p>

<h3><a id="installation-awsaccount"></a>1. AWS Account</h3>
<p>
I'm assuming you have an AWS account 
        (<a href="http://aws.amazon.com/free/" target="_blank">get one</a>),
        and a key pair
        (<a href="http://www.codeproject.com/Articles/889059/Amazon-Web-Services-part-How-to-deploy-a-load-bala#keypair" target="_blank">get one</a>).
    </p>
<h3>2. Download</h3>
<p>
Download all the 
        <a href="https://github.com/mperdeck/AWS-articles/tree/master/4" target="_blank">components</a>
         to a directory on your computer.
        It may be easiest to simply 
        <a href="https://github.com/mperdeck/AWS-articles" target="_blank">download the entire Github project</a>
         with all the articles in this series and then grab the components.

</p>

<h3>3. Set user policy</h3>
<p>
The user (probably yourself) that will run the Publish.ps1 script
        needs to have all the permissions required to spin up all the different infrastructure elements.
</p>
<p>
    You express these permissions as an 
    <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/PoliciesOverview.html" target="_blank">IAM policy</a>.
You then attach that policy to the user.
</p>
<p>
    First create the policy:
</p>

<ol>
    <li>
        Sign into the <a href="aws.amazon.com" target="_blank">AWS Console</a>;
    </li>
    <li>
        Click <i>Services</i> (top of the screen) | <i>IAM</i> | <i>Policies</i> | <i>Create Policy</i>;
    </li>
    <li>
        Click <i>Select</i> for <i>Create your own policy</i>;
    </li>
    <li>
        Make up a nice name for your new policy, such as &quot;Publish-CloudFormation-Stack&quot;. 
        Whatever name you choose, write it down somewhere.
    </li>
    <li>
        Open the
        <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/user%20policy.txt" target="_blank">user policy</a> file
        you just downloaded and copy and paste its content to the <i>Policy Document</i>. You'll see that a policy is simply a JSON object.
    </li>
    <li>
        Click <i>Create Policy</i>;
    </li>
</ol>

<p>
    Then attach your new policy to the user:
</p>

<ol>
    <li>
Click <i>Users</i>;
    </li>
<li>
    Click the user that will be running the Publish.ps1 script;
</li>
    <li>
        Click <i>Attach Policy</i>;
    </li>
    <li>
        Enter the policy you just created in the filter. Select your policy. Click <i>Attach Policy</i>; 
    </li>
</ol>

<h3><a id="credentialsstore"></a>4. Store credentials in credentials store</h3>
<p>
    When you run an AWS PowerShell command, it sends a message to AWS to make an update or retrieve information.
Just as you need to log into AWS before you can do this manually, the 
    command must carry credentials, so it can be authenticated by AWS.
</p>
<p>
    You could pass your credentials to each command, but that means your credentials are exposed in your PowerShell scripts.
</p>
<p>
    A better way is to store your credentials in a 
    <a href="http://docs.aws.amazon.com/powershell/latest/userguide/specifying-your-aws-credentials.html" target="_blank">credentials store</a>, 
    which is simply a file on your machine: 
</p>
<ol>
    <li>
    Get the access key and secret key of the user that will run the Publish.ps1 script
    (<a href="http://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSGettingStartedGuide/AWSCredentials.html" target="_blank">how</a>).
<p />
    </li>
<li>
        Think of a name for your new credentials store, such as &quot;mycredentials&quot;.
<p />
</li>
<li>
    Open a PowerShell command line and run:
    <p>
<pre>Set-AWSCredentials -AccessKey &lt;acess key&gt; -SecretKey &lt;secret key&gt; -StoreAs &lt;store name&gt;</pre>
</p>

</li>
</ol>    
    
<p>
    As an aside, if you have a look at the
    <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/publish.ps1">Publish.ps1</a>
    script, you'll see that it uses this command to tell 
    the PowerShell commands in the current session to use the credentials in the credentials store:
</p>
<pre>Set-AWSCredentials -ProfileName &lt;store name&gt; </pre>

<a id="cidr"></a>
<h3>5. Find your CIDR</h3>

<p>
          You don't want everybody in the world to be able to try and RDP into your EC2 instances
      or SSMS into your database servers.
</p>
<p>
    To lock this down, the Publish.ps1 script lets you pass in the 
      <a href="http://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing" target="_blank">CIDR</a>
of the machine that can RDP or SSMS into your servers.
</p>
<p>
    To find the CIDR of your machine:
</p>
<ol>
    <li>
        <a href="http://www.findmyip.org/" target="_blank">Get your external IP address</a>;
    </li>
    <li>
        Add <i>/32</i> at the end. So if your IP address is <i>130.180.2.320</i>, your CIDR  is
        <i>130.180.2.320/32</i>.
    </li>
</ol>

<a id="optiongroup"></a>
<h3>6. Create RDS option group to switch on SQL Server mirroring</h3>

<p>
    You only need to do this
    if you plan to use a Multi-AZ deployment.
</p>
<p>
    AWS' implementation of Multi-AZ deployments for SQL Server
    is based on the 
    <a href="https://msdn.microsoft.com/en-us/library/ms189852.aspx" target="_blank">SQL Server Mirroring</a>
    feature.
    To switch on this feature,
    you need to associate your RDS instance with an 
    <a href="http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Appendix.SQLServer.Options.html#Appendix.SQLServer.Options.Mirroring" target="_blank">option group</a>
     that has the mirroring option enabled.
</p>
<p>
    Because this option group is simply a bit of infrastructure, you'd think you can create this
    in a CloudFormation template. Oddly, that cannot be done. You have to create it manually once off.
When you run Publish.ps1, you'll pass in the name of the option group that you create here via a 
    <a href="#Publish-Parameters-OptionGroupName">parameter</a>.
</p>
<p>
    To create the option group:
</p>
<ol>
    <li>
        In the AWS console, click <i>Services</i> | <i>RDS</i> | <i>Option Groups</i> | <i>Create Group</i>;
    </li>
<li>
    Think of a name for your option group, such as &quot;sqlserver-mirroring&quot;.
    Fill in a name and description. Write down the name, you'll need it later on;
</li>
    <li>
        Set <i>Engine</i> to <i>sqlserver-se</i> (Standard Edition) or <i>sqlserver-ee</i> (Enterprise Edition);
    </li>
    <li>
        Set <i>Major Engine Version</i> to version 11 (which is the same as the <i>EngineVersion</i> specified in the
        <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/Template%20with%20SQL%20Server%20Standard%20and%20Multi%20AZ%20deployment/Ec2RdsRoute54.template"
            target="_blank">CloudFormation template</a>);
    </li>
    <li>
        Click <i>Create</i>. This creates your option group and takes you back to the option groups list;
    </li>
    <li>
        Select your new option group;
    </li>
    <li>
        Click <i>Add Option</i> (near top of the page);
    </li>
    <li>
        <i>Mirroring</i> is the only option. You probably want to set <i>Apply Immediately</i> to <i>Yes</i>. Click <i>Add Option</i>.
    </li>
</ol>

<h3>7. Run Publish.ps1 script</h3>
<p>
    With the preliminaries done, you can now run the 
    <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/publish.ps1" target="_blank">Publish.ps1</a>
    script to spin up the infrastructure
    and deploy the web site.
</p>

<h4>Time to run</h4>

<p>
    Running this script takes a while.
    Spinning up a new stack and deploying the site
    takes about 20 minutes in my experience.
    If you go for a stack with a Multi-AZ database deployment, 50 minutes is more like it.
</p>
<p>
    Luckily, updates (running the script again for the same stack) tend to take far less time because CloudFormation
    does the minimum necessary to do the updates. 
</p>

<h4>Domain</h4>

<p>
    If you own a spare domain name that you want to use here, you'll pass that to the script
    via the <a href="#Publish-Parameters-Websitedomain">websiteDomain</a> parameter.
</p>
<p>
    If you don't have a domain to use right now, just use a bogus domain such as &quot;mybogusdomain.com&quot;.
</p>

<h4>Usage of the Publish.ps1 script</h4>

<pre>.\publish.ps1 -version &lt;code version&gt; -stackName &lt;stack name&gt; -websiteDomain &lt;web site domain&gt; -keyName &lt;key name&gt; 
    -credentialsStoreName &lt;credential store name&gt; -adminCidr &lt;admin cidr&gt; -dbMasterUsername &lt;database username&gt; 
    -dbMasterUserPassword &lt;database password&gt; -bucketName &lt;S3 bucket to store code&gt; -templatePath &lt;template file&gt; 
    -csProjPath &lt;.csproj file of your web site&gt; -dbOptionGroupName &lt;option group name&gt; -stackPolicyPath &lt;file with stack policy&gt</pre>

<h4>Example</h4>
<p>
    This is just an example that spins up infrastructure without a Multi-AZ deployment. 
    It assumes you stored the downloaded files in a directory &quot;c:\aws&quot;.
</p>
<p>
   
    Do not copy blindly, but use your own 
    <a href="#Publish-Parameters">parameter values</a>, especially the ones that are <u>underlined</u> below.
</p>

<pre>.\publish.ps1 -version 1.0.0 -stackName teststack -websiteDomain mybogusdomain.com -keyName <u>mykeyname</u> 
    -credentialsStoreName <u>mycredentials</u> -adminCidr <u>124.171.5.210/32</u> 
    -dbMasterUsername dbusername -dbMasterUserPassword 'MustBe$uperHardToGu3ss!' 
    -bucketName <u>must-be-unique-across-all-S3-buckets-in-AWS</u> 
    -templatePath 'c:\aws\Template with SQL Server Express\Ec2RdsRoute54.template' 
    -csProjPath 'c:\aws\SimpleSiteWithDb\SimpleSiteWithDb\SimpleSiteWithDb.csproj'
    -stackPolicyPath 'c:\aws\stackpolicy.txt'</pre>

<h4>PowerShell special characters in parameter values</h4>
<p>
    If any parameter values contain a $, enclose it with single quotes ('), not with double quotes. That way, PowerShell won't regard the $ as 
    the start of a variable and try to expand it.
</p>


<a id="Publish-Parameters"></a>
<h4>Parameters</h4>

<dl>
  <dt><b>version</b></dt>
  <dd><p>
      Version of the code you're deploying. For example &quot;2.1.0&quot;. 
The version doubles as the name of the code package in the S3 bucket.
If you're running Publish.ps1 to update infrastructure whilst keeping the web application the same, use the same version.
  </p></dd>

  <dt><b>stackName</b></dt>
  <dd><p>
       For example, &quot;Test&quot; or
      &quot;Live&quot;.
      The set of servers, etc. you create with a template is called a stack. You can create a different set of servers
      by passing in a different stack name.
  </p></dd>

  <dt><b><a id="Publish-Parameters-Websitedomain"></a>websiteDomain</b></dt>
  <dd><p>
      
      Domain of the web site that will be associated with the name servers. For example, &quot;mydomain.com&quot; for your Live stack, or &quot;test-domain.com&quot; for your Test stack.
  </p></dd>

  <dt><b>keyName</b></dt>
  <dd><p>
      Name of the key pair that you
      created <a href="#installation-awsaccount">earlier</a>.
      You'll use this to log into your EC2 instances. Remember that key pairs are tied to a region.
  </p></dd>

  <dt><b>credentialsStoreName</b></dt>
  <dd><p>
      Name of the credentials store where you stored your credentials 
      <a href="#credentialsstore">earlier</a>.
  </p></dd>

  <dt><b>adminCidr</b></dt>
  <dd><p>
      Use the CIDR you found
      <a href="#cidr">earlier</a>.
  </p></dd>

  <dt><b>dbMasterUsername</b></dt>
  <dt><b>dbMasterUserPassword</b></dt>
  <dd><p>
      RDS only supports SQL Server Authentication. These are the username and password that will be able
      to access your new database server via SSMS, and that will be inserted into your web.config.
  </p></dd>

  <dt><b>bucketName</b></dt>
  <dd><p>
      S3 bucket where the code packages will be stored. This name must be unique across all S3 buckets
      hosted by AWS. To make sure a given S3 bucket name is available, it would be easiest to create the S3 bucket yourself
      and then pass your chosen name in via this parameter: click<i>Services</i> | <i>S3</i>.
  </p></dd>

  <dt><b>templatePath</b></dt>
  <dd><p>
      Path to the CloudFormation template to use. 
      Use one of the 
      <a href="#solutioncomponents-template-nofailover">templates in the downloads</a>
      or use your own.
      <p>
          If you use your own template and it has 
          <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html" target="_blank">parameters</a>,
          be aware that the 
           <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/publish.ps1" target="_blank">Publish.ps1</a>
          script sets only a limited set of parameters (in the method <i>launch-stack</i>).
          All other parameters must be optional and/or have defaults.
      </p>
  </p></dd>

  <dt><b>csProjPath</b></dt>
  <dd><p>
      Path of the .csproj file of the web site you're deploying. The Publish.ps1 script will build the site in release mode,
      package up the code and store the package in the S3 bucket.
  </p></dd>

  <dt><b><a id="Publish-Parameters-OptionGroupName"></a>dbOptionGroupName (optional)</b></dt>
  <dd><p>
      Name of the option group you created 
      <a href="#optiongroup">earlier</a> that has mirroring enabled. Only use this if you're 
      using a template that creates a SQL Server Standard Edition (or higher) database server
      (such as <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/Template%20with%20SQL%20Server%20Express/Ec2RdsRoute54.template"
            target="_blank">this template</a>).
        <p>
            If you try to use such an option group with an engine that does not support mirroring, such as SQL Server Express or SQL Server Web Edition,
            CloudFormation will fail to create your stack.
        </p>
  </p></dd>

  <dt><b>stackPolicyPath (optional)</b></dt>
  <dd><p>
      File path of a <a href="#solutioncomponents-stackpolicy">stack policy</a> to protect for example your database during stack updates
      (<a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/stackpolicy.txt" target="_blank">example</a>).
      If you do not use a stack policy, do not use this parameter.
  </p></dd>

<h3>8. Set nameservers</h3>

    <p>
        After you've created your stack, you need to change the configuration of your
        domain name so it uses your 
        <a href="#infrastructuregoal-route53">new Route53 name servers</a>.
    </p>
    <p>
        Part 3 of this series described how to do that
        <a href="http://www.codeproject.com/Articles/891202/Amazon-Web-Services-part-How-to-point-your-domain#pointdomaintolb" target="_blank">here</a>.
    </p>

<h3>9. Copy data and schema from old database</h3>

    <p>
        If you have an existing database, you'll want to copy its schema and data to your new RDS database.
        Part 2 of this series described how to do that 
        <a href="http://www.codeproject.com/Articles/889910/Amazon-Web-Services-part-Adding-a-database-to-your#copyschemaanddata" target="_blank">here</a>.
    </p>
    <p>
        Unless you delete your database server,
        this needs to be done only once after the initial creation of your stack.
    </p>




    <a id="implementation"></a><h2>Implementation notes</h2>
    <p>
        This section isn't a detailed discussion of every file
        in the 
        <a href="https://github.com/mperdeck/AWS-articles/tree/master/4" target="_blank">downloads</a>.
Instead, it        
        discusses some of the more interesting
things I learned when building this solution.
    </p>


<h3><a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/Template%20with%20SQL%20Server%20Express/Ec2RdsRoute54.template"
            target="_blank">CloudFormation template</a></h3>
    <p>
        On a high level, a CloudFormation template is simply a long list of infrastructure resources.
        The 
        <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-guide.html" target="_blank"
            >introduction to building CloudFormation templates</a>
        is well worth reading, as is the
        <a href="http://aws.amazon.com/documentation/cloudformation/" target="_blank">user guide</a>.
        There are also 
        the
        <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/pseudo-parameter-reference.html" target="_blank">Pseudo Parameters Reference</a>
        and the
        <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference.html" target="_blank">Intrinsic Function Reference</a>.
    </p>

    <p>
        I gained a lot from looking at
        <a href="http://aws.amazon.com/cloudformation/aws-cloudformation-templates/" target="_blank">sample templates and snippets</a>.
        Also, each resource has a type, such as <i>AWS::RDS::DBInstance</i>. Googling those types and understanding what they do taught me a lot
        on how AWS works.
    </p>

<p>
    Having said that, there were a few tricky bits I wanted to discuss here.
</p>


    <h4>Loading a code package onto a new EC2 instance</h4>
    <p>
        The 
        <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-as-group.html" target="_blank"
            >auto scaling group</a>
        is responsible for creating new EC2 instances.
        This includes installing the web application, 
        installing IIS, etc.
    </p>

    <p>
        This installation work is handled by a
        <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-as-launchconfig.html" target="_blank"
            >launch configuration</a> - a separate resource. 
If you search for 
        <i>AWS::AutoScaling::AutoScalingGroup</i> in the
        <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/Template%20with%20SQL%20Server%20Express/Ec2RdsRoute54.template"
            target="_blank">template</a>,
        you'll find  that it is associated with the auto scaling group via the
        auto scaling group's 
        <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-as-group.html#cfn-as-group-launchconfigurationname"
            target="_blank">LaunchConfigurationName</a>
        property.
    </p>
    <p>
        If you now search for
        <i>LaunchConfig</i>,
        you'll find that it knows everything about configuring a new EC2 instance, including the AMI image id, its instance type
        and everything related to installing the web application. The installation story is spread over two properties:
        the <i>UserData</i> property and the
        <i>AWS::CloudFormation::Init</i> object in the <i>Metadata</i> property.
    </p>

    The
    <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-as-launchconfig.html#cfn-as-launchconfig-userdata"
        target="_blank">UserData</a> property contains 
    scripts that will run on the new EC2 instance. Oddly, it is 
    <a href="http://en.wikipedia.org/wiki/Base64" target="_blank">Base64</a>
    encoded.
    Luckily, the built in
    <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference.html" target="_blank">intrinsic function</a>
   Fn::Base64  does the Base64 encoding for us:
    </p>
<pre>"LaunchConfig" : {
      "Type" : "AWS::AutoScaling::LaunchConfiguration",
      "Properties" : {
		  "UserData" : { "<a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-base64.html" target="_blank"
        >Fn::Base64</a>" : { "<a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-join.html" target="_blank">Fn::Join</a>" : ["", [
			"&lt;script&gt;\n",
                "... MS-DOS commands ... \n"
			"&lt;/script&gt;\n",
			"&lt;powershell&gt;\n",
                "... PowerShell commands ... \n"
			"&lt;/powershell&gt;\n"
		  ]] } }
  	    }
    }
</pre>
    <p>
        In this template,
        the one MS-DOS command is 
        the
        <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-init.html" target="_blank">cfn-init.exe</a> program.
        This 
        <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-helper-scripts-reference.html" target="_blank"
            >CloudFormation Helper Script</a> is always available on an EC2 instance.
        It actions the meta data in the 
        AWS::CloudFormation::Init
        object.
        You'll see 
        <a href="#implementation-template-cloudformationinit">below</a>
         that the <i>AWS::CloudFormation::Init</i>
        says to
        load a package file (a .zip file) from the S3 bucket
        and extract the files into the
        <i>c:\inetpub\deploy</i> directory.
    </p>
    <p>
        After <i>cfn-init.exe</i> has executed, the PowerShell script kicks in.
        This finds all <i>Deploy.ps1</i> scripts within the code package and 
        <a href="https://technet.microsoft.com/en-us/library/hh849893.aspx" target="_blank">invokes</a>
         them.
        Note that it has to 
        <a href="https://technet.microsoft.com/en-us/library/hh849812.aspx" target="_blank">set the execution policy</a>
         to <i>Bypass</i> temporarily to allow this to happen.
        It then cleans up the 
        <i>c:\inetpub\deploy</i> directory.
    </p>

    <a id="implementation-template-cloudformationinit"></a>
    <p>
The
    <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-init.html" target="_blank">AWS::CloudFormation::Init</a>
        documentation is well worth reading.
        One of its many tricks is the
        <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-init.html#aws-resource-init-sources" target="_blank"
            >sources</a> section, which allows you to download a .zip file from a URL and extract it into a directory on the EC2 instance.
        Here that URL is the package in the S3 bucket, but you could also load the .zip file from Github.
    </p>
<p>
    In principle you can extract the files in any directory. However, keep in mind that:
</p>
<ul>
    <li>
        <i>c:\inetpub\temp</i> is used by IIS for its own purposes. Deleting it does break things.
    </li>
    <li>
        <i>c:\inetpub\wwwroot</i> is used by the default web site.
    </li>
    <li>
        <i>%temp%</i> gets expanded into the temporary directory by Windows Explorer, but 
    not by AWS::CloudFormation::Init.
</li>
</ul>
<p>
    This is why in the end I used 
    <i>c:\inetpub\deploy</i>
    as a temporary directory to extract the web application.
</p>

    <h4>Starting the software update process</h4>
    <p>
        You can run the Publish.ps1 script to purely install
        a new version of your web application, without changes to the CloudFormation template.
    As part of this, Publish.ps1 uploads a new package to the S3 bucket.
        Question is how to get the launch configuration to pick up this new version and 
        replace EC2 instances running the old version with EC2 instances running the new version.
    </p>

    <p>
        When you update a property of a 
        launch configuration,
        that launch configuration gets replaced by a new configuration.
        Then when its auto scaling group creates new EC2 instances, those instances 
        <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-as-launchconfig.html" target="_blank"
            >receive the latest version</a>      
         of your web application.
    </p>

    <p>
        If you have a look at the <i>AWS::CloudFormation::Init</i> object used in the launch configuration,
        you see that the <i>sources</i> property changes
        when you update the 
        <i>Version</i> parameter.
        This is because the name of every package is based on the version.
        So that solves how to give new EC2 instances the latest web application version.
    </p>
    <p>
        Basing the names of packages on their version means that packages of previous versions are preserved (unless you manually delete them).
        Obviously this takes space.
        In order to save space, you could give all packages the same name, so old packages get overwritten (you would have to modify the
        Publish.ps1 script).
        However, in that case the 
        <i>sources</i> property no longer changes with the version.
    </p>
    <p>
To still have the launch configuration replaced when the version changes,
        you could set the <i>Version</i> property on the <i>Metadata</i>:
    </p>

<pre>&quot;LaunchConfig&quot; : {
    &quot;Type&quot; : &quot;AWS::AutoScaling::LaunchConfiguration&quot;,
    &quot;Metadata&quot; : {
        &quot;Version&quot; : { &quot;Ref&quot; : &quot;Version&quot; },</pre>

    <p>
Finally,
        to have the existing EC2 instances replaced,
        you have to specifiy
        an 
        <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-attribute-updatepolicy.html" target="_blank"
            >UpdatePolicy Attribute</a>
        for your auto scaling group
        (in the template, search for &quot;UpdatePolicy&quot;).
        This specifies properties for your rolling updates, such as many EC2 insances get replaced in one go.
    </p>


 <a id="allows3read"></a><h4>Allowing EC2 instances to read a file from an S3 bucket</h4>

    <p>
        For the EC2 instances to load the package from the S3 bucket, they have to have permission to do so.
    </p>
    <p>
        This can be done by creating a 
        <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/roles-toplevel.html" target="_blank">role</a>.
        This is a collection of permissions that can be assigned to for example a user on a temporary basis.
        The permissions themselves are contained in a 
        <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/PoliciesOverview.html" target="_blank">policy</a>,
        which needs to be attached to the role.
    </p>
    <p>
        In the template, the permission to execute a <i>GetObject</i> action (that is, load a file)
        on the package is encoded in a policy in the 
        <i>RolePolicies</i> resource
        of type 
        <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-iam-policy.html" target="_blank">AWS::IAM::Policy</a>.
        Its <i>Roles</i> property
        attaches the policy to the
        <i>InstanceRole</i>
        resource of type
        <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-iam-role.html" target="_blank">AWS::IAM::Role</a>.
    </p>
    <p>
        An added twist is that it isn't the EC2 instance itself that will be loading the package, but software
        running under Windows on that virtual machine. Because of this,
        <i>InstanceRole</i> needs to be first added to an
        <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-iam-instanceprofile.html" target="_blank">InstanceProfile</a>
        (<a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/roles-usingrole-ec2instance.html" target="_blank">details</a>).
        In the template this InstanceProfile is imaginatively called
<i>InstanceProfile</i>.
    </p>
    <p>
        Finally, we can now 
        attach
<i>InstanceProfile</i>
        to the 
        <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-as-launchconfig.html" target="_blank">launch configuration</a>
        (resource <i>LaunchConfig</i>)
        via its
        <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-as-launchconfig.html#cfn-as-launchconfig-iaminstanceprofile"
             target="_blank">IamInstanceProfile</a>
        property.
    </p>

        <h4>Setting credentials for retrieving resources listed in AWS::CloudFormation::Init</h4>
    <p>
        In addition to 
        <a href="#allows3read">allowing EC2 instances to read a file from an S3 bucket</a>,
        you also need to provide credentials for accessing those files (unless they are not protected at all).
    </p>
    <p>
        You do this by adding a
        <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-authentication.html" target="_blank">AWS::CloudFormation::Authentication</a>
        object to the Metadata
        of your 
        launch configuration (search for &quot;AWS::CloudFormation::Authentication&quot; in 
        <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/Template%20with%20SQL%20Server%20Express/Ec2RdsRoute54.template"
            target="_blank">the template</a>).
You can use this to provide credentials for any resources or files listed in your
    <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-init.html" target="_blank">AWS::CloudFormation::Init</a>
object.
If you were to retrieve files or resources from for example Github,
        this would be the place to provide your Github credentials.
    </p>
    <p>
        As far as providing credentials for the S3 bucket is concerned, the simplest way here
        is to rever to the <i>InstanceRole</i> object
        that had already been created by the template.
    </p>

    <p>Some pages that I found useful:</p>
    <ul>
        <li>
        <a href="http://blog.kloud.com.au/2013/08/05/bootstrapping-on-aws/" target="_blank">Bootstrapping on AWS</a>
            </li>
        <li>
            <a href="https://github.com/awslabs/aws-hangouts/blob/master/20140130_cfn/README.md" target="_blank"
                >AWS CloudFormation Office Hours: January 30, 2014</a>
        </li>
        <li>
            <a href="http://blogs.aws.amazon.com/application-management/post/Tx3LKFZ27CWZBKO/Authenticated-File-Downloads-with-CloudFormation"
                 target="_blank">Authenticated File Downloads with CloudFormation</a>
        </li>
    </ul>

    
    


    




    <h4>Adding version tags to EC2 instances</h4>
    <p>
        One goal was to have a version tag on each EC2 instance, to make it easy to find out what software version 
        it runs. Of course, EC2 instances get created and terminated by the auto scaling group, so you can't add tags directly to them.
    </p>
<p>
    A simple solution is to add the version tag to the auto scaling group itself
    (<a href="http://docs.aws.amazon.com/AutoScaling/latest/DeveloperGuide/ASTagging.html" target="_blank">details</a>).
    If you look at the 
    <i>WebServerGroup</i> (of type 
    <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-as-group.html#cfn-as-group-tags" target="_blank"
        >AWS::AutoScaling::AutoScalingGroup</a>),
    you'll find that it has a 
    <i>Tags</i>
    property 
containing the version tag.
    Setting 
    <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-as-tags.html#cfn-as-tags-PropagateAtLaunch" target="_blank"
        >PropagateAtLaunch</a> to <i>true</i> ensures that the tag will be copied to newly launced EC2 instances.
</p>


  <h3><a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/publish.ps1" target="_blank">Publish.ps1</a></h3>
    <p>
        You run this PowerShell script to create or update a stack.
    </p>
    <p>
This script interacts with AWS using PowerShell Cmdlets provided by
        <a href="http://aws.amazon.com/powershell/" target="_blank">AWS Tools for Windows PowerShell</a>.
        I found that this works well and is very well documented.
    </p>

    <p>
        Some things I learned while writing this script:
    </p>
    <ul>
        <li>
            Some sample CloudFormation templates on the Internet hard code  
            the ID of the 
            <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html" target="_blank">Amazon Machine Image</a> (AMI)
           to use with EC2 instances.
            I followed their lead, until one day I found that the AMI I had hardcoded no longer existed.
            <p>       
            In fact, AWS 
            <a href="http://docs.aws.amazon.com/powershell/latest/userguide/pstools-ec2-get-amis.html" target="_blank">regularly provides</a>
             new updated AMIs with new IDs, so hard coding IDs won't work long term. The solution was to get the latest EC2 instance AMI
                each time you create or update a stack:
                <pre>$imageId = (Get-EC2ImageByName -Names WINDOWS_2012R2_BASE | Select -ExpandProperty ImageId)</pre>
            </p>            
        </li>

        <li>
            At the end of the method <i>launch-stack</i>, it waits until the stack has been completely created or updated.
            It does this by polling the status of the stack every 5 seconds (in method <i>waitfor-stack-status</i>).
            I had to interpret the AWS stack status (a string) to find out whether the create/update had succeeded/failed or was still in progress.
            This was made easier by having the 
            <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-describing-stacks.html" target="_blank">full set of stack status codes</a>.
        <p />
        </li>
        <li>
            The Cmdlets 
            <i></i>
            <a href="http://docs.aws.amazon.com/powershell/latest/reference/items/New-CFNStack.html" target="_blank">New-CFNStack</a>
            and 
            <a href="http://docs.aws.amazon.com/powershell/latest/reference/items/Update-CFNStack.html" target="_blank">Update-CFNStack</a>
are used to create/update a stack using a template.
            When your template creates an 
            <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-iam-instanceprofile.html" target="_blank">IAM Instance Profile</a>,
             for example to give EC2 instances access to an S3 bucket,
            you have to allow the Cmdlets to use that template by
            passing in   
            &quot;CAPABILITY_IAM&quot; 
            via the 
            Capability parameter:
            <pre>New-CFNStack -Capability @( &quot;CAPABILITY_IAM&quot; ) ....</pre>
        </li>
        <li>
            In method <i>upload-deployment</i>), 
            I used 
            <a href="https://msdn.microsoft.com/en-us/library/dd393574.aspx" target="_blank">MSBuild</a>
            and more specifically its 
            <a href="http://vishaljoshi.blogspot.com.au/2009/02/web-packaging-creating-web-packages.html" target="_blank">Package</a>
            target to build and package up the web application into a single .zip file using the line:
            <pre>msbuild $csProjPath /t:Package /p:Configuration=Release /p:PackageLocation=$releaseZip /p:AutoParameterizationWebConfigConnectionStrings=False</pre>
            <p>
                I looked at alternatives such as 
                <a href="http://docs.octopusdeploy.com/display/OD/Using+OctoPack" target="_blank">OctoPack</a>, but this is the simplest way and it works well.
            </p>
            <p>
                By default, the <i>Package</i> target 
                replaces the web.config's connection by a replacable token, which is not what I want here.
                Setting <i>AutoParameterizationWebConfigConnectionStrings</i> to <i>False</i> suppresses this behaviour.  
            </p>
        </li>
    </ul>

   <h3><a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/SimpleSiteWithDb/SimpleSiteWithDb/Deploy.ps1" target="_blank"
            >Deploy.ps1 PowerShell script</a></h3>
    <p>
        This PowerShell script runs on the EC2 instance after the web application package has been copied there and has been unzipped.
        It isn't complicated and well documented.
    </p>
    <p>A few interesting things:</p>
    <ul>
        <li>
            You'll see that I used 
            <a href="https://technet.microsoft.com/en-us/library/cc772200(v=ws.10).aspx" target="_blank">appcmd.exe</a>
            to work with IIS, rather than easier to use 
            <a href="https://technet.microsoft.com/en-us/library/ee790599.aspx" target="_blank">IIS Cmdlets in PowerShell</a>.
<p>
            The reason behind this is that the IIS Cmdlets require the
            WebAdministration module to have been loaded, and I found I couldn't count on this always being the case.
            So I used appcmd.exe which always works.
</p>
        </li>
        <li>
            I was sometimes confronted with the error message
            <i>HTTP Error 500.21 - Internal Server Error Handler "ExtensionlessUrlHandler-Integrated-4.0" has a bad module "ManagedPipelineHandler" in its module list</i>.
<p>
            The solution was to re-install the .Net framework
            (<a href="http://stackoverflow.com/questions/13162545/handler-extensionlessurlhandler-integrated-4-0-has-a-bad-module-managedpipeli"
                target="_blank">Stack Overflow discussion</a>), using
            <pre>cmd /c %systemroot%\Microsoft.NET\Framework\v4.0.30319\aspnet_regiis.exe -i</pre>
</p>
        </li>
        <li>
            Be careful with the PowerShell Cmdlet <i>Out-File</i>. By default it produces a file with encoding Unicode.
            IIS chokes on this when reading for example web.config. I believe that in most cases you're better off with UTF8 anyway:
            <pre>Out-File ..... -encoding UTF8</pre>
        </li>

    </ul>

    <h3><a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/SimpleSiteWithDb/SimpleSiteWithDb/Web.Release.config" target="_blank"
        >Trial site Web.Release.config</a></h3>
    <p>
        This is the web.config transform that generates the release version of the web.config. You can see the placeholders
        that will be replaced by Deploy.ps1.
    </p>

    <p>
    Some connection strings use <i>Integrated Security=<a
        href="http://stackoverflow.com/questions/1229691/difference-between-integrated-security-true-and-integrated-security-sspi" target="_blank"
        >SSPI</a>;</i>. Do not use this with an AWS hosted site. It will cause AWS to try to log into your database with the 
    <i>NT AUTHORITY\ANONYMOUS LOGON</i> account rather than your own account - which will fail. 
</p>

<a id="nextparts"></a><h2>Next Parts</h2>

<p>
    In 
    <a href="http://www.codeproject.com/search.aspx?q=amazon+web+services+perdeck&x=0&y=0&sbo=kw">future parts</a>,
I am intending to
    write about deploying a stack from 
    <a href="https://www.jetbrains.com/teamcity/" target="_blank">TeamCity</a>,
    <a href="http://martinfowler.com/bliki/BlueGreenDeployment.html" target="_blank">blue/green deployments</a> and
    breaking large templates into manageable pieces.
</p>







