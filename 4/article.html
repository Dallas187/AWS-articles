<ul class="download">
<li><a href="https://github.com/mperdeck/AWS-articles/tree/master/4" target="_blank">Download templates, scripts, sample app</a></li>
</ul>

<a id="introduction"></a>
<h2>Introduction</h2>
<p>
    This is part 4 of a 
    <a href="http://www.codeproject.com/search.aspx?q=amazon+web+services+perdeck&x=0&y=0&sbo=kw" target="_blank">series of articles</a>
     about deploying your site to 
    <a href="http://aws.amazon.com/" target="_blank">Amazon Web Services</a> (AWS), 
    Amazon's counterpart to <a href="http://azure.microsoft.com/en-us/" target="_blank">Windows Azure</a>.
</p>
<p>
    In parts 1, 2 and 3, you saw how to use 
    the AWS service
                <a href="http://aws.amazon.com/elasticbeanstalk/" target="_blank">Elastic Beanstalk</a> to
    deploy a load balanced IIS based web site with a SQL Server database and its own domain name.
    This involved defining your EC2 servers, database server, etc. by completing a series of menus.
</p>

<h2>Why CloudFormation</h2>
<p>
    Once your environment becomes a big more complicated,
    you'll quickly run into some drawbacks with this method:
</p>
<ul>
    <li>
        <b>Repeatabality</b> -
        You or a co-worker needs a carbon copy of your infrastructure in some other region.
        Or you need a test environment that is the same as your live environment.
        With menus, you're reduced to writing down every step and manually creating the copy.
<p />
    </li>
<li>
    <b>Source control</b> - 
    There is no system to track changes by you or your co-workers.
    No rolling back if you make a mistake.
<p />
</li>
<li>
    <b>Documentation</b> -
    To find out what's in an environment you have to hunt around the AWS dashboards.
<p />
</li>

</ul>
<p>
    The solution is to express your environment in a text file.
    This is easy to store, give to others and source control.
</p>
<p>
The AWS service
        <a href="http://aws.amazon.com/cloudformation/" target="_blank">CloudFormation</a>
    lets you do exactly that. You define everything as a single large JSON object in a <i>template</i> file.
    CloudFormation takes that file and creates all the servers, load balancers, etc. you specified.
This environment is called a <i>stack</i>.
</p>
<p>
  When it comes time to modify your stack - remove/add servers, upgrade/downgrade servers, etc. -
    you change your template and invoke CloudFormation again. It will figure out how to modify your existing stack
    to your desired new stack making the fewest changes and causing the least disruption. 
</p>
<p>Stacks have their own name, such as &quot;Test&quot; or &quot;Live&quot;. You can have multiple stacks
    and manage them independently. If you want 2 identical stacks, you'd use the same template to create them both.
</p>
<p>
    In addition to infrastructure, CloudFormation
    will also deploy software for you, such as a web application.
</p>

<h2>About this article</h2>

<p>
    CloudFormation is a low level tool.
    Whereas Elastic Beanstalk takes care of lots of details such as creating the right security groups,
    you have to define all this in your template. There are many details to get right - and many ways
    to get it wrong. I found that the learning curve can be quite steep.
</p>
<p>
    When I set out to create an MVC web site with SQL Server using CloudFormation, I found that:
</p>
<ul>
    <li>
        To even get something simple working required getting many bits in place;
    </li>
    <li>
    The AWS documentation is extensive, but it only gets you 90% there.
You still have to figure many things out on your own.
    </li>
    <li>
        Although AWS and others provide sample code,
        this was too simple or sketchy for my purposes.
    </li>
</ul>

<p>
    So I'm publishing the fully fledged working solution here that I arrived at.
    You should be able to use this as is for your own web application, or use it as a basis for your own solution.
</p>
<p>
    Note that this is not a introduction to CloudFormation or AWS.
    The focus of this article is on describing the solution I came up with.
    However, it has many links to relevant parts of the AWS documentation
    to get all the details. This is not too hard and you'll learn a lot.
</p>

<a id="solution-goals"></a>
<h2>Goals for this solution</h2>

<p>
    The solution described in this article
     sets out to achieve 2 goals: to deploy certain 
    infrastructure
    and to 
    <a href="#solution-goal-software">deploy a web application and its updates</a>.
</p>


<a id="infrastructuregoal"></a>
<h3>Infrastructure Goal</h3>


<p>
    The infrastructure goal was to deploy a web site that uses a database and that has its own domain:
</p>
<img src="cfarchitecture.png" width="500" />

<p>
    Lets start from the center of the picture:
</p>
<ul>
    <li>
        <b>Web servers on EC2 instances</b> -
        The web site will run on one or more <a href="http://aws.amazon.com/ec2/" target="_blank">EC2 instances</a> - virtual machines in the AWS cloud
        acting as web servers.
        <p />
    </li>
    <li>
        <b>SQL Server database server</b> -
        The web sites access a SQL Server database hosted on an 
        <a href="http://aws.amazon.com/rds/" target="_blank">RDS</a> (Relational Database Service) instance. 
        RDS is a fully managed database server as a service with automatic 
        backups, etc. 
        <p />
    </li>
    <li>
        <b>SQL Server standby</b> -
        For enhanced  availability, you can 
        use a 
        <a href="http://aws.amazon.com/rds/details/multi-az/" target="_blank">Multi-AZ deployment</a>
        where a standby database server automatically takes over when the main database server fails.
        Although reasonably priced for a company, this feature is probably too expensive for a personal site.
        So I created both a CloudFormation 
                <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/Template%20with%20SQL%20Server%20Express/Ec2RdsRoute54.template"
            target="_blank">template without a standyb</a>
         and 
        a 
        <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/Template%20with%20SQL%20Server%20Standard%20and%20Multi%20AZ%20deployment/Ec2RdsRoute54.template"
            target="_blank">template with a standby</a>.
        <p />
    </li>
    <li>
        <b>Auto Scaling Group</b> -
        The <a href="http://aws.amazon.com/autoscaling/" target="_blank">auto scaling group</a> starts more EC2 instances when the existing
        instances get overloaded, and terminates instances when there is little to do. 
        <p />
    </li>
    <li>
        <b>Code package stored in S3 bucket</b> -
        Seeing that the auto scaling group starts and terminates EC2 instances at will, there is no point in deploying software to
        individual servers. Instead, a package file with the code making up the web application is stored in an 
        <a href="http://aws.amazon.com/s3/" target="_blank">S3</a> bucket (the S3 service lets you store files in the cloud).
        When the auto scaling group starts a new EC2 instance, it retrieves the package from the S3 bucket and installs it on the new instance. 
        <p />
    </li>
    <li>
        <b>Load Balancer</b> -
        The <a href="http://aws.amazon.com/elasticloadbalancing/" target="_blank">ELB</a> (Elastic Load Balancer)
        receives web requests from the Internet and parcels them out to the available web servers.
        <p />
    </li>
    <li>
        <a id="infrastructuregoal-route53"></a>
        <b>DNS Name Servers</b> -
        Used to translate your domain name to the IP address of the load balancer.
       Provided by the <a href="http://aws.amazon.com/route53/" target="_blank">Route 53</a> service.
    </li>
</ul>

<a id="solution-goal-software"></a>
<h3>Software deployment goal</h3>
<p>
    The solution also achieves some software deployment related goals:
    </p>
<ul>
    <li>
<b>Packaging</b>
-        Packages up an ASP.NET web project
        and store the packet in an S3 bucket.
        <p />
    </li>
    <li>
<b>Deployment</b> - 
        Installs IIS, etc. on new EC2 instances with a Deploy.ps1 script.
        <p />
    </li>
    <li>
<b>Version tags</b> -
        Adds tags with the current software version to the EC2 instances, 
        to make it easy to see what version a particular instance is running.
        <p />
    </li>
    <li>
<b>Terminate and Replace</b> -
        EC2 instances are never updated with new software versions.
        Instead, instances running old software are terminated and new EC2 instances created with the new software.
        This ensures that all EC2 instances are in the same known state, and that they all have the latest Windows patches.
        <p />
    </li>
    <li>
<b>Rolling updates</b> -
        EC2 instances are replaced one by one, so there are always instances running to serve requests.
        If there is only one EC2 instance, a temporary second instance is created.
        <p />
    </li>
    <li>
        <b>Web.config updated</b>
        -
        During deployment, the web.config file is updated with the version number, and the server name, user name and user password of the database server.
    </li>
</ul>

<p>
    I didn't look into database schema updates.
    If you use
    <a href="https://msdn.microsoft.com/en-au/data/jj193542.aspx" target="_blank">Entity Framework Code First</a>,
    the web application itself will update the schema for you.
    However, I appreciate more work would be needed if you can't use Entity Framework or Code First.
</p>


<a id="solutioncomponents"></a>
<h2>Solution Components</h2>
<p>
    The solution consists of a number of templates, scripts, etc., 
    which are in the 
    <a href="https://github.com/mperdeck/AWS-articles/tree/master/4" target="_blank">downloads</a>.
The
    <a href="#installation">next section</a>
shows how to use those components.
</p>

<ul>
    <li><a id="solutioncomponents-template-nofailover"></a>
        <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/Template%20with%20SQL%20Server%20Express/Ec2RdsRoute54.template"
            target="_blank">CloudFormation template without database server standby</a> 
        that specifies the infrastructure without the database server standby.
        <p />
    </li>
    <li>
        <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/Template%20with%20SQL%20Server%20Standard%20and%20Multi%20AZ%20deployment/Ec2RdsRoute54.template"
            target="_blank">CloudFormation template with database server standby</a> that 
        that specifies the infrastructure with the database server standby.
        <p />
    </li>
    <li>
        <a href="https://github.com/mperdeck/AWS-articles/tree/master/4/Downloads/SimpleSiteWithDb" target="_blank">Very simple sample web site</a>
        that uses a database. You may want to use this to experiment before moving to something more complicated.
        <p>
            If you have a look at its web.config file, you'll find that it has a web.release.config transform
            to generate the Release version. That Release version has the placeholders
            <i>{{DbUsername}}</i>,
            <i>{{DbPassword}}</i>,
            <i>{{DbServer}}</i> and
            <i>{{Version}}</i>.
During deployment these will be replaced by the actual database server details and the software version. 
          </p>
    </li>
    <li>
        <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/SimpleSiteWithDb/SimpleSiteWithDb/Deploy.ps1" target="_blank"
            >Deploy.ps1</a> PowerShell script.
        <ul>
            <li>
                After a new web server is created by the auto scaling group, any Deploy.ps1 script inside the source tree of your web site is executed 
                on the new webserver. 
            </li>
            <li>
                Receives software version, database server details, etc. via parameters.
            </li>
            <li>
                Responsible for starting IIS, replacing placeholders in the web.config, etc.
            </li>
        </ul>
        <p />
    </li>
   <li>
       <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/publish.ps1" target="_blank">Publish.ps1</a>
       PowerShell script that packages up your web application, stores it in an S3 bucket and calls the CloudFormation service
      with a template
        to deploy the infrastructure and web application. Also updates an existing stack. 
        <p />
   </li>
   <li>
       <a id="solutioncomponents-stackpolicy"></a>
       <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/stackpolicy.txt" target="_blank">Stack policy</a>
       that determines what servers can be replaced during an update.
       Use this to prevent CloudFormation from for example replacing a database server
       (<a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" target="_blank">more about stack policies</a>).
        <p />
   </li>
   <li>
       <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/user%20policy.txt" target="_blank">User policy</a>
       that provides the Publish.ps1 script all the permissions it needs to spin up the infrastructure.
   </li>
</ul>

<a id="costs"></a>
<h2>Costs</h2>
<p>
    Using AWS services is not free. This section is to spell this out.
    Personally, I found the amounts involved to be tiny,
    except for Multi-AZ deployments - do not leave these running overnight.
</p>
<table style=" border: 1px solid black;  border-spacing: 0px;   border-collapse:collapse">
    <tr>
        <th style="padding: 5px; border: 1px solid black;">
            Pricing Page
        </th>
        <th style="padding: 5px; border: 1px solid black;">
            Service is used for
        </th>
    </tr>
    <tr>
        <td style="padding: 5px; border: 1px solid black;">
            <a href="http://aws.amazon.com/cloudformation/pricing/" target="_blank">CloudFormation</a>
        </td>
        <td style="padding: 5px; border: 1px solid black;">
            Deployment configuration
        </td>
    </tr>
    <tr>
        <td style="padding: 5px; border: 1px solid black;">
            <a href="http://aws.amazon.com/ec2/pricing/" target="_blank">EC2 t2.micro instances</a>
        </td>
        <td style="padding: 5px; border: 1px solid black;">
            Virtual machines running web servers
        </td>
    </tr>
    <tr>
        <td style="padding: 5px; border: 1px solid black;">
            <a href="http://aws.amazon.com/elasticloadbalancing/pricing/" target="_blank">Elastic Load Balancing</a>
        </td>
        <td style="padding: 5px; border: 1px solid black;">
            Load balancer
        </td>
    </tr>
    <tr>
        <td style="padding: 5px; border: 1px solid black;">
            <a href="http://aws.amazon.com/autoscaling/pricing/" target="_blank">Auto Scaling</a>
        </td>
        <td style="padding: 5px; border: 1px solid black;">
            Spinning up/down web servers in response to traffic load
        </td>
    </tr>
    <tr>
        <td style="padding: 5px; border: 1px solid black;">
            <a href="http://aws.amazon.com/route53/pricing/" target="_blank">Route53</a>
        </td>
        <td style="padding: 5px; border: 1px solid black;">
            DNS name servers
        </td>
    </tr>
    <tr>
        <td style="padding: 5px; border: 1px solid black;">
            <a href="http://aws.amazon.com/s3/pricing/" target="_blank">S3</a>
        </td>
        <td style="padding: 5px; border: 1px solid black;">
            Storing software packages
        </td>
    </tr>
    <tr>
        <td style="padding: 5px; border: 1px solid black;">
            <a href="http://aws.amazon.com/rds/pricing/" target="_blank">RDS</a>,
            <a href="http://aws.amazon.com/rds/sqlserver/pricing/" target="_blank">SQL Server licence</a>
        </td>
        <td style="padding: 5px; border: 1px solid black;">
            Database server (see below)
        </td>
    </tr>
</table>
<h3>
    Some useful tools
</h3><ul>
    <li>
        <a href="http://calculator.s3.amazonaws.com/index.html" target="_blank">Simple Monthly Calculator</a>
    </li>
    <li>
        <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_EstimateTemplateCost.html" target="_blank">Estimate Template Cost</a>
    </li>
    <li>
        <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-paying.html" 
            target="_blank">Estimating the Cost of Your AWS CloudFormation Stack</a> (once your stack is running)
    </li>

</ul>

<h3>Multi-AZ deployment</h3>

<p>
    Multi-AZ deployments are much more expensive than a database server without standby.
</p>
<p>
    Amazon have implemented fail over for SQL Server servers using
    the 
    <a href="https://msdn.microsoft.com/en-us/library/ms189852.aspx" target="_blank">SQL Server Mirroring feature</a>. This feature is 
    <a href="https://msdn.microsoft.com/en-us/library/cc645993.aspx" target="_blank">not available</a>
     on SQL Server Express.
</p>
<p>
    As of March 2015, Your cheapest option that supports mirroring would be a SQL Server Standard Edition database
    on a db.m1.small instance
    (<a href="http://aws.amazon.com/rds/previous-generation/" target="_blank">pricing</a>).
</p><p>
    Keep in mind that AWS will charge you for the SQL Server Standard Edition licence, while a SQL Server Express licence is free.
</p><p>
    Also, you'll be paying for 2 database servers - the main server and the standby.
</p><p>
    If you're just playing around,
    I wouldn't keep a Multi-AZ deployment running overnight.
</p>

<a id="installation"></a>
<h2>Detailed installation steps</h2>

<p>
    This section shows how to spin up the infrastructure
    plus deploy a web application. First we need to get some once-off preliminaries out of the way, and then
    we can run the Publish.ps1 script to create the stack. You can use the same script to update your stack later on.
</p>

<h3>1. AWS Account</h3>
<p>
I'm assuming you have an AWS account 
        (<a href="http://aws.amazon.com/free/" target="_blank">get one</a>),
        and a key pair
        (<a href="http://www.codeproject.com/Articles/889059/Amazon-Web-Services-part-How-to-deploy-a-load-bala#keypair" target="_blank">get one</a>).
    </p>
<h3>2. Download</h3>
<p>
Download all the 
        <a href="https://github.com/mperdeck/AWS-articles/tree/master/4" target="_blank">components</a>
         to a directory on your computer.
        It may be easiest to simply 
        <a href="https://github.com/mperdeck/AWS-articles" target="_blank">download the entire Github project</a>
         with all the articles in this series and then grab the components.

</p>

<h3>3. Set user policy</h3>
<p>
The user (probably yourself) that will run the Publish.ps1 script
        needs to have all the permissions required to spin up all the different infrastructure elements.
</p>
<p>
    You express these permissions as an 
    <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/PoliciesOverview.html" target="_blank">IAM policy</a>.
You then attach that policy to the user.
</p>
<p>
    First create the policy:
</p>

<ol>
    <li>
        Sign into the <a href="aws.amazon.com" target="_blank">AWS Console</a>;
    </li>
    <li>
        Click <i>Services</i> (top of the screen) | <i>IAM</i> | <i>Policies</i> | <i>Create Policy</i>;
    </li>
    <li>
        Click <i>Select</i> for <i>Create your own policy</i>;
    </li>
    <li>
        Make up a nice name for your new policy, such as &quot;Publish-CloudFormation-Stack&quot;. 
        Whatever name you choose, write it down somewhere.
    </li>
    <li>
        Open the
        <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/user%20policy.txt" target="_blank">user policy</a> file
        you just downloaded and copy and paste its content to the <i>Policy Document</i>. You'll see that a policy is simply a JSON object.
    </li>
    <li>
        Click <i>Create Policy</i>;
    </li>
</ol>

<p>
    Then attach your new policy to the user:
</p>

<ol>
    <li>
Click <i>Users</i>;
    </li>
<li>
    Click the user that will be running the Publish.ps1 script;
</li>
    <li>
        Click <i>Attach Policy</i>;
    </li>
    <li>
        Enter the policy you just created in the filter. Select your policy. Click <i>Attach Policy</i>; 
    </li>
</ol>

<h3><a id="credentialsstore"></a>4. Store credentials in credentials store</h3>
<p>
    When you run an AWS PowerShell command, you have to specify your credentials, similar to logging into AWS.
    You could pass your credentials to each command, but that means your credentials are exposed in your PowerShell scripts.
</p>
<p>
    A better way is to store your credentials in a 
    <a href="http://docs.aws.amazon.com/powershell/latest/userguide/specifying-your-aws-credentials.html" target="_blank">credentials store</a>.
    This is file stored on your machine. You give that credentials store a name. Inside your script, you then specify that name
    to get all PowerShell commands to use your credentials.
</p>

<p>
    To make this work, you need the access key and secret key of the user that will run your Publish.ps1 script
    (<a href="http://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSGettingStartedGuide/AWSCredentials.html" target="_blank">how to get these</a>).
</p>
<p>
    You also need to think of a name for your new credentials store. Maybe something like &quot;mycredentials&quot;.
</p>
<p>
    Now open a PowerShell command window and enter:
</p>
<pre>Set-AWSCredentials -AccessKey &lt;acess key&gt; -SecretKey &lt;secret key&gt; -StoreAs &lt;store name&gt;</pre>

<p>
    If you have a look at the 
    <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/publish.ps1">Publish.ps1</a>
    script, it uses this line to make the credentials available to the PowerShell commands in the current session:
</p>
<pre>Set-AWSCredentials -ProfileName &lt;store name&gt; </pre>

<a id="optiongroup"></a>
<h3>5. Create RDS option group to switch on SQL Server mirroring</h3>

<p>
    You only need to do this if you want your SQL Server database server to have automatic fail over
    to a hot standby.
</p>
<p>
    AWS refers to this as a 
    <a href="http://aws.amazon.com/rds/details/multi-az/" target="_blank">Multi-AZ deployment</a>
    (<a href="http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.MultiAZ.html" target="_blank">more details</a>).
    It is based on the 
    <a href="https://msdn.microsoft.com/en-us/library/ms189852.aspx" target="_blank">SQL Server Mirroring</a>
    feature, available in 
    <a href="https://msdn.microsoft.com/en-us/library/cc645993.aspx" target="_blank">SQL Server Standard Edition</a>
    and higher (but not SQL Server Express or SQL Server Web).
</p>
<p>
    To switch on mirroring,
    you need to associate an 
    <a href="http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Appendix.SQLServer.Options.html#Appendix.SQLServer.Options.Mirroring" target="_blank">option group</a>
     that has the mirroring option enabled
    with your SQL Server database server.
</p>
<p>
    The Publish.ps1 script takes care of attaching the option group.
    And it would have been natural to specify the option group along with all the other infrastructure 
    in the CloudFormation template. However, oddly, CloudFormation doesn't let you create option groups.
    You'll have to create one manually once off.
</p>
<p>
    To create the option group:
</p>
<ol>
    <li>
        In the AWS console, click <i>Services</i> | <i>RDS</i> | <i>Option Groups</i> | <i>Create Group</i>;
    </li>
<li>
    Fill in a name and description. Write down the name, you'll need it later on;
</li>
    <li>
        Set <i>Engine</i> to <i>sqlserver-se</i> (Standard Edition) or <i>sqlserver-ee</i> (Enterprise Edition);
    </li>
    <li>
        Set <i>Major Engine Version</i> to version 11 (which is the same as the <i>EngineVersion</i> specified in the
        <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/Template%20with%20SQL%20Server%20Standard%20and%20Multi%20AZ%20deployment/Ec2RdsRoute54.template"
            target="_blank">CloudFormation template</a>);
    </li>
    <li>
        Click <i>Create</i>. This creates your option group and takes you back to the option groups list;
    </li>
    <li>
        Select your new option group;
    </li>
    <li>
        Click <i>Add Option</i> (near top of the page);
    </li>
    <li>
        <i>Mirroring</i> is the only option. You probably want to set <i>Apply Immediately</i> to <i>Yes</i>. Click <i>Add Option</i>.
    </li>
</ol>

<h3>6. Run Publish.ps1 script</h3>
<p>
    With the preliminaries done, you can now run the 
    <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/publish.ps1" target="_blank">Publish.ps1</a>
    script to spin up all the infrastructure
    and deploy the web site.
</p>

<h4>Time to run</h4>

<p>
    Running this script takes a while.
    Spinning up a new stack and deploying the site
    takes about 20 minutes in my experience.
    If you go for a stack with a Multi-AZ database deployment, 50 minutes is more like it.
    Luckily, updates (running the script again for the same stack) take far less time because CloudFormation
    does the minimum necessary to do the updates. 
</p>

<h4>Domain</h4>

<p>
    If you own a spare domain name that you want to use here, you'll pass that to the script
    via the <a href="#Publish-Parameters-Websitedomain">websiteDomain</a> parameter.
</p>
<p>
    If you don't have a domain to use right now, just use a bogus domain such as &quot;mybogusdomain.com&quot;.
</p>

<h4>Usage of the Publish.ps1 script</h4>

<pre>.\publish.ps1 -version &lt;code version&gt; -stackName &lt;stack name&gt; -websiteDomain &lt;web site domain&gt; -keyName &lt;key name&gt; 
    -credentialsStoreName &lt;credential store name&gt; -adminCidr &lt;admin cidr&gt; -dbMasterUsername &lt;database username&gt; 
    -dbMasterUserPassword &lt;database password&gt; -bucketName &lt;S3 bucket to store code&gt; -templatePath &lt;template file&gt; 
    -csProjPath &lt;.csproj file of your web site&gt; -dbOptionGroupName &lt;option group name&gt; -stackPolicyPath &lt;file with stack policy&gt</pre>

<h4>Parameters</h4>

<dl>
  <dt>version</dt>
  <dd>
      Version of the code you're deploying. For example &quot;2.1.0&quot;. Each time you deploy a new version of your code,
      use a new version. The version doubles as the name of the code package in the S3 bucket, so make sure it is unique.
  </dd>

  <dt>stackName</dt>
  <dd>
      The set of servers, etc. you create with a template is called a stack. You can create a different set of servers
      by passing in a different stack name. For example, you could create a stack &quot;Test&quot; and another stack called
      &quot;Live&quot;.
  </dd>

  <dt>websiteDomain</dt>
  <dd>
      <a id="Publish-Parameters-Websitedomain"></a>
      Domain of the web site. For example, &quot;mydomain.com&quot; for your Live stack, or &quot;test-domain.com&quot; for your Test stack.
  </dd>

  <dt>keyName</dt>
  <dd>
      Name of the key pair that you'll use to log into your EC2 instances. Remember that key pairs are tied to a region.
      To find a key pair name, click <i>Services</i> | <i>Key Pairs</i>.
  </dd>

  <dt>credentialsStoreName</dt>
  <dd>
      Name of the credentials store where you stored your credentials 
      <a href="#credentialsstore">earlier</a>.
  </dd>

  <dt>adminCidr</dt>
  <dd>
      You don't want everybody in the world to be able to try and log into your EC2 instances
      or database servers via SSMS.
      Here you pass the
      <a href="http://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing" target="_blank">CIDR</a>
      from which someone can log in. Typically, that would be the CIDR of your own machine
      (<a href="http://www.findmyip.org/" target="_blank">Your IP address</a> | 
      <a href="http://www.ipaddressguide.com/cidr#range" target="_blank">Convert IP to CIDR</a>).
  </dd>

  <dt>dbMasterUsername</dt>
  <dt>dbMasterUserPassword</dt>
  <dd>
      RDS only supports SQL Server Authentication. These are the username and password that will be able
      to access your new database server via SSMS, and that will be inserted into your web.config.
  </dd>

  <dt>bucketName</dt>
  <dd>
      S3 bucket where the code packages will be stored. This name must be unique across all S3 buckets
      hosted by AWS. To make sure a given S3 bucket name is available, create the S3 bucket yourself: click<i>Services</i> | <i>S3</i>.
  </dd>

  <dt>templatePath</dt>
  <dd>
      Path to the CloudFormation template to use. 
      You could use one of the 
      <a href="#solutioncomponents-template-nofailover">templates in the downloads</a>
      or use your own.
      <p>
          If you use your own template and it has 
          <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html" target="_blank">parameters</a>,
          be aware that the 
           <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/publish.ps1" target="_blank">Publish.ps1</a>
          script sets only a limited set of parameters (in the method <i>launch-stack</i>).
          All other parameters must be optional and/or have defaults.
      </p>
  </dd>

  <dt>csProjPath</dt>
  <dd>
      Path of the .csproj file of the web site you're deploying. The Publish.ps1 script will build the site in release mode,
      package up the code and store the package in the S3 bucket.
  </dd>

  <dt>dbOptionGroupName (optional)</dt>
  <dd>
      Name of the option group you created 
      <a href="#optiongroup">earlier</a> that has mirroring enabled. Only use this if you're 
      using a template that creates a SQL Server Standard Edition (or higher) database server
      (such as <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/Template%20with%20SQL%20Server%20Express/Ec2RdsRoute54.template"
            target="_blank">this template</a>).
        <p>
            If you try to use such an option group with an engine that does not support mirroring, such as SQL Server Express or SQL Server Web Edition,
            CloudFormation will fail to create your stack.
        </p>
  </dd>

  <dt>stackPolicyPath (optional)</dt>
  <dd>
      File path of a <a href="#solutioncomponents-stackpolicy">stack policy</a> to protect for example your database during stack updates
      (<a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/stackpolicy.txt" target="_blank">example</a>).
      If you do not use a stack policy, do not use this parameter.
  </dd>

<h3>7. Set nameservers</h3>

    <p>
        After you've created your stack, you need to change the configuration of your
        domain name so it uses your 
        <a href="#infrastructuregoal-route53">new Route53 name servers</a>.
    </p>
    <p>
        Part 3 of this series described how to do that
        <a href="http://www.codeproject.com/Articles/891202/Amazon-Web-Services-part-How-to-point-your-domain#pointdomaintolb" target="_blank">here</a>.
    </p>

<h3>8. Copy data and schema from old database</h3>

    <p>
        If you have an existing database, you'll want to copy its schema and data to your new RDS database.
        Part 2 of this series described how to do that 
        <a href="http://www.codeproject.com/Articles/889910/Amazon-Web-Services-part-Adding-a-database-to-your#copyschemaanddata" target="_blank">here</a>.
    </p>
    <p>
        Unless you completely delete your stack,
        this needs to be done only once after the initial creation of your stack.
    </p>

    <a id="implementation"></a>
<h2>Implementation notes</h2>

@@@@@@@@@@@@@@@@@@@@@@@



<a id="nextparts"></a>
<h2>Next Parts</h2>

<p>
    In 
    <a href="http://www.codeproject.com/search.aspx?q=amazon+web+services+perdeck&x=0&y=0&sbo=kw">future parts</a>,
I am intending to
    write about deploying a stack from 
    <a href="https://www.jetbrains.com/teamcity/" target="_blank">TeamCity</a>,
    <a href="http://martinfowler.com/bliki/BlueGreenDeployment.html" target="_blank">blue/green deployments</a> and
    breaking large templates into manageable pieces.
</p>







