<ul class="download">
<li><a href="https://github.com/mperdeck/AWS-articles/tree/master/4" target="_blank">Download templates, scripts, sample app</a></li>
</ul>

<a id="introduction"></a>
<h2>Introduction</h2>
<p>
    This is part 4 of a 
    <a href="http://www.codeproject.com/search.aspx?q=amazon+web+services+perdeck&x=0&y=0&sbo=kw" target="_blank">series of articles</a>
     about deploying your site to 
    <a href="http://aws.amazon.com/" target="_blank">Amazon Web Services</a> (AWS), 
    Amazon's counterpart to <a href="http://azure.microsoft.com/en-us/" target="_blank">Windows Azure</a>.
</p>
<p>
    In parts 1, 2 and 3, you saw how to deploy a load balanced IIS based web site with a SQL Server database and its own domain name.
</p>
<a id="architecture"></a>
<img src="architecture.png" width="400" />

<p>
    Those parts showed how to do this using 
the AWS service
                <a href="http://aws.amazon.com/elasticbeanstalk/" target="_blank">Elastic Beanstalk</a>. 
    This allows you to define a configuration with EC2 servers, database server, etc. by completing a series of menus.
</p>
<p>
    This article introduces AWS 
    <a href="http://aws.amazon.com/cloudformation/" target="_blank">CloudFormation</a>.
    This service too lets you create servers and deploy code. But instead of completing menus, you express your desired configuration
    in a text file called a template. You then tell CloudFormation to &quot;launch&quot; this template to create a &quot;stack&quot; - AWS 
    speak for the servers, etc. you specified in the template.
</p>
<p>
    Each stack has a name, such as &quot;Live&quot; or &quot;Test&quot;. To change the server configuration
    for a stack, you first change the template and then tell CloudFormation to update the stack. It will then
    migrate your stack to the desired configuration expressed in your new template, with as little disruption as possible.  
</p>
<p>
    CloudFormation gives you much more control than Elastic Beanstalk, but there are many more details to get right - and many ways
    to get it wrong. I found that the learning curve can be quite steep.
</p>

<a id="thisarticle"></a>
<h2>What is in this article</h2>
<p>
    This article shows how to:
</p>
<ul>
    <li>
        Deploy all web and database servers and other infrastructure, as specified in a CloudFormation template (a text file);
    </li>
    <li>
        And then deploy the code of an ASP.NET web site;
    </li>
    <li>
        Update the web.config of the site with the server name and login details of the RDS database;
    </li>
    <li>
        Get IIS, etc. started on the web servers so the site is up and running;
    </li>
    <li>
        All fully hands off, by running a single PowerShell script.
    </li>
</ul>
<p>
    After you've deployed your servers and web sites, you can use the same PowerShell script to update your configuration:
</p>
<ul>
    <li>
        If you changed your CloudFormation template, for example to add or remove servers,
        all required changes will be made automatically with minimal disruption;
    </li>
    <li>
        If you created a new version of your web site code, the web servers will be upgraded automatically:
        <ul>
            <li>
        Rather than taking all servers off line, the servers are upgraded one by one to minimize disruption.
            </li>
            <li>
        Instead of upgrading servers in place, new servers are created running the new software and servers running the old software 
        are terminated. This ensures your servers are all in the same known state after an upgrade. 
            </li>
        </ul>
    </li>
</ul>

<a id="whycloudformation"></a>
<h2>Why use CloudFormation?</h2>
<p>
    Why would you express your desired server configuration in a text file and then
    have 
    CloudFormation
    build that configuration for you? Why not launch the servers yourself from the AWS management console?
</p>
<ul>
<li>
    <b>Repeatable</b> - Having your configuration in a text file makes it trivial to create
    a new environment with the same configuration. For example, make a carbon copy of your live environment
    for testing purposed.
</li>
<li>
    <b>Source control</b> - 
    A text file can easily be stored in your 
    favorite source control system, such as GIT or TFS. Keep track of changes,
    roll back to previous versions, etc.
</li>
<li>
    <b>Documentation</b> -
    A text files makes it easier to figure out what bits and pieces of infrastructure
    you have lying around.
</li>
    </ul>
<p>
    Essentially, CloudFormation lets you manage your infrastructure in a similar way to
    the code base of your web site.
</p>

<a id="infrastructuregoal"></a>
<h2>Infrastructure goal</h2>
<p>
    The goal is to deploy a web site that uses a database and that has its own domain. The infrastructure
    is going to look like this:
</p>
<img src="cfarchitecture.png" width="500" />

<p>
    Lets start from the center of the picture:
</p>
<ul>
    <li>
        <b>Web servers on EC2 instances</b> -
        The web site will run on one or more <a href="http://aws.amazon.com/ec2/" target="_blank">EC2 instances</a> - virtual machines in the AWS cloud
        running IIS.
    </li>
    <li>
        <b>SQL Server database server</b> -
        The web sites access one or more SQL Server databases hosted on an 
        <a href="http://aws.amazon.com/rds/" target="_blank">RDS</a> (Relational Database Service) instance. 
        RDS is a fully managed database server as a service with automatic 
        backups, etc. 
    </li>
    <li>
        <b>SQL Server failover replica</b> -
        To achieve high availability, you can have a hot standby that automatically takes over when the database server fails.
        This solution is probably too expensive for a personal site, but very reasonably priced for a company.
        @@@@@@@ pricing details @@@@@@@@

        In the downloads you'll find templates for both the solution with replica and the solution without replica. 
    </li>
    <li>
        <b>Auto Scaling group</b> -
        The <a href="http://aws.amazon.com/autoscaling/" target="_blank">Auto Scaling group</a> starts more EC2 instances when the existing
        instances get overloaded, and terminates instances when there is little to do. 
    </li>
    <li>
        <b>Code package stored in S3 bucket</b> -
        Seeing that the Auto Scaling group starts and terminates EC2 instances at will, there is no point in deploying software to
        individual servers. Instead, a package file with all the code is stored in an 
        <a href="http://aws.amazon.com/s3/" target="_blank">S3</a> bucket (the S3 service lets you store files in the cloud).
        When the Auto Scaling group starts a new EC2 instance, it retrieves the package from the S3 bucket and installs it on the new instance. 
    </li>
    <li>
        <b>Load Balancer</b> -
        The <a href="http://aws.amazon.com/elasticloadbalancing/" target="_blank">ELB</a> (Elastic Load Balancer)
        receives web requests from the Internet and parcels them out to the available web servers.
    </li>
    <li>
        <b>DNS Name Servers</b> -
        To translate your domain name to the IP address of the load balancer,
        we'll use the  
        <a href="http://aws.amazon.com/route53/" target="_blank">Route 53</a> service
        to provide the required name servers.
        You will have to manually update the settings of your domain at your registrar
        so it uses these new name servers. This is a one off.
    </li>
</ul>


@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
web.config placeholders




<a id="solutioncomponents"></a>
<h2>Solution Components</h2>
<p>
    Lets have a look at the bits of code that will create all this.
    These are all in the 
    <a href="https://github.com/mperdeck/AWS-articles/tree/master/4" target="_blank">downloads</a>.
Detailed installation instructions are in the 
    <a href="#installation">next section</a>.
</p>

<ul>
    <li><a id="solutioncomponents-template-nofailover"></a>
        <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/Template%20with%20SQL%20Server%20Express/Ec2RdsRoute54.template"
            target="_blank">CloudFormation template</a> that describes in detail all the bits of infrastructure we're after.
        This template spins up a SQL Server Express database server without failover replica.
        <p />
    </li>
    <li>
        <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/Template%20with%20SQL%20Server%20Standard%20and%20Multi%20AZ%20deployment/Ec2RdsRoute54.template"
            target="_blank">CloudFormation template</a> that 
        spins up a SQL Server Standard Edition database server with failover replica.
        <p />
    </li>
    <li>
        <a href="https://github.com/mperdeck/AWS-articles/tree/master/4/Downloads/SimpleSiteWithDb" target="_blank">Very simple sample web site</a>
        that uses a database. You may want to use this to experiment before moving to something more complicated.
        <p />
    </li>
    <li>
        <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/SimpleSiteWithDb/SimpleSiteWithDb/Deploy.ps1" target="_blank"
            >Deploy.ps1</a> PowerShell script. Sits in the root directory of the web site. Is executed after the Auto Scaling group
        has placed your web site code on a newly created web server. Responsible for starting IIS, etc. When you decide to deploy some other
        web site, be sure to copy over this PowerShell script to its root directory.
        <p />
    </li>
   <li>
       <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/publish.ps1" target="_blank">Publish.ps1</a>
       PowerShell script that packages up your web site code, stores it in the S3 bucket and calls the CloudFormation service
       to deploy the infrastructure. Also used to update an existing stack. 
        <p />
   </li>
   <li>
       <a id="solutioncomponents-stackpolicy"></a>
       <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/stackpolicy.txt" target="_blank">Stack policy</a>
       that determines what servers can be replaced during an update.
       When you update your stack, then some changes may involve CloudFormation terminating a server and starting a new
       one with the new configuration. That's ok for a web server, but not for a database server where you'd lose all your data
       (<a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" target="_blank">more about stack policies</a>).
        <p />
   </li>
   <li>
       <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/user%20policy.txt" target="_blank">User policy</a>
       that provides the Publish.ps1 script all the permissions it needs to spin up all the infrastructure.
   </li>
</ul>





<a id="installation"></a>
<h2>Detailed installation steps</h2>

<h3>1. AWS Account</h3>
<p>
I'm assuming you have an AWS account 
        (<a href="http://aws.amazon.com/free/" target="_blank">get one</a>),
        and that you have a key pair
        (<a href="http://www.codeproject.com/Articles/889059/Amazon-Web-Services-part-How-to-deploy-a-load-bala#keypair" target="_blank">get one</a>).
    </p>
<h3>2. Download</h3>
<p>
Download all the 
        <a href="https://github.com/mperdeck/AWS-articles/tree/master/4" target="_blank">components</a>
         to a directory on your computer.
        It may be easiest to simply 
        <a href="https://github.com/mperdeck/AWS-articles" target="_blank">download the entire Github project</a>
         with all the articles in this series and then grab the components.

</p>

<h3>3. Set user policy</h3>
<p>
The user (probably yourself) that will run the Publish.ps1 script
        needs to have all the permissions required to spin up all the different infrastructure elements.
</p>
<p>
    You express these permissions in the form of an
    <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/PoliciesOverview.html" target="_blank">IAM policy</a>.
You then attach that policy to the user.
</p>
<p>
    First create the policy:
</p>

<ol>
    <li>
        Sign into the <a href="aws.amazon.com" target="_blank">AWS Console</a>;
    </li>
    <li>
        Click <i>Services</i> (top of the screen) | <i>IAM</i> | <i>Policies</i> | <i>Create Policy</i>;
    </li>
    <li>
        Click <i>Select</i> for <i>Create your own policy</i>;
    </li>
    <li>
        Make up a nice name for your new policy, such as &quot;Publish-CloudFormation-Stack&quot;. 
        Whatever name you choose, write it down somewhere.
    </li>
    <li>
        Open the
        <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/user%20policy.txt" target="_blank">user policy</a> file
        you just downloaded and copy and paste its content to the <i>Policy Document</i>. You'll see that a policy is simply a JSON object.
    </li>
    <li>
        Click <i>Create Policy</i>;
    </li>
</ol>

<p>
    Then attach your new policy to the user:
</p>

<ol>
    <li>
Click <i>Users</i>;
    </li>
<li>
    Click the user that will be running the Publish.ps1 script;
</li>
    <li>
        Click <i>Attach Policy</i>;
    </li>
    <li>
        Enter the policy you just created in the filter. Select your policy. Click <i>Attach Policy</i>; 
    </li>
</ol>

<h3><a id="credentialsstore"></a>4. Store credentials in credentials store</h3>
<p>
    When you run an AWS PowerShell command, you have to specify your credentials.
    You could pass your credentials to each command, but that means your credentials are exposed in your PowerShell scripts.
</p>
<p>
    A better way is to store your credentials in a 
    <a href="http://docs.aws.amazon.com/powershell/latest/userguide/specifying-your-aws-credentials.html" target="_blank">credentials store</a>.
    This is file stored on your machine. You give that credentials store a name. Inside your script, you can then specify that name
    to get all PowerShell commands to use your credentials.
</p>

<p>
    To make this work, you need the access key and secret key of the user that will run your Publish.ps1 script
    (<a href="http://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSGettingStartedGuide/AWSCredentials.html" target="_blank">how to get these</a>).
</p>
<p>
    You also need to think of a name for your new credentials store. Maybe something like &quot;mycredentials&quot;.
</p>
<p>
    Now open a PowerShell command window and enter:
</p>
<pre>Set-AWSCredentials -AccessKey &lt;acess key&gt; -SecretKey &lt;secret key&gt; -StoreAs &lt;store name&gt;</pre>

<p>
    If you have a look at the 
    <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/publish.ps1">Publish.ps1</a>
    script, it uses this line to make the credentials available to the PowerShell commands in the current session:
</p>
<pre>Set-AWSCredentials -ProfileName &lt;store name&gt; </pre>

<a id="optiongroup"></a>
<h3>5. Create RDS option group to switch on SQL Server mirroring</h3>

<p>
    You only need to do this if you want your SQL Server database server to have automatic fail over
    to a hot standby.
</p>
<p>
    AWS refers to this as a 
    <a href="http://aws.amazon.com/rds/details/multi-az/" target="_blank">Multi-AZ deployment</a>
    (<a href="http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.MultiAZ.html" target="_blank">more details</a>).
    It is based on the 
    <a href="https://msdn.microsoft.com/en-us/library/ms189852.aspx" target="_blank">SQL Server Mirroring</a>
    feature, available in 
    <a href="https://msdn.microsoft.com/en-us/library/cc645993.aspx" target="_blank">SQL Server Standard Edition</a>
    and higher (but not SQL Server Express or SQL Server Web).
</p>
<p>
    To switch on mirroring,
    you need to associate an 
    <a href="http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Appendix.SQLServer.Options.html#Appendix.SQLServer.Options.Mirroring" target="_blank">option group</a>
     that has the mirroring option enabled
    with your SQL Server database server.
</p>
<p>
    The Publish.ps1 script takes care of attaching the option group.
    And it would have been natural to specify the option group along with all the other infrastructure 
    in the CloudFormation template. However, oddly, CloudFormation doesn't let you create option groups.
    You'll have to create one manually once off.
</p>
<p>
    To create the option group:
</p>
<ol>
    <li>
        In the AWS console, click <i>Services</i> | <i>RDS</i> | <i>Option Groups</i> | <i>Create Group</i>;
    </li>
<li>
    Fill in a name and description. Write down the name, you'll need it later on;
</li>
    <li>
        Set <i>Engine</i> to <i>sqlserver-se</i> (Standard Edition) or <i>sqlserver-ee</i> (Enterprise Edition);
    </li>
    <li>
        Set <i>Major Engine Version</i> to version 11 (which is the same as the <i>EngineVersion</i> specified in the
        <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/Template%20with%20SQL%20Server%20Standard%20and%20Multi%20AZ%20deployment/Ec2RdsRoute54.template"
            target="_blank">CloudFormation template</a>);
    </li>
    <li>
        Click <i>Create</i>. This creates your option group and takes you back to the option groups list;
    </li>
    <li>
        Select your new option group;
    </li>
    <li>
        Click <i>Add Option</i> (near top of the page);
    </li>
    <li>
        <i>Mirroring</i> is the only option. You probably want to set <i>Apply Immediately</i> to <i>Yes</i>. Click <i>Add Option</i>.
    </li>
</ol>

<h3>6. Run Publish.ps1 script</h3>
<p>
    With the preliminaries done, you can now run the 
    <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/publish.ps1" target="_blank">Publish.ps1</a>
    script to spin up all the infrastructure
    and deploy the web site.
</p>
<p>

    @@@@@@@@@@@@@@@@
    start times (50min for fail over!)

    @@@@@@@@@@@@@@@@@@@
    pricing
</p>



<p>
    Usage of the Publish.ps1 script:
</p>
<pre>.\publish.ps1 -version &lt;code version&gt; -stackName &lt;stack name&gt; -websiteDomain &lt;web site domain&gt; -keyName &lt;key name&gt; 
    -credentialsStoreName &lt;credential store name&gt; -adminCidr &lt;admin cidr&gt; -dbMasterUsername &lt;database username&gt; 
    -dbMasterUserPassword &lt;database password&gt; -bucketName &lt;S3 bucket to store code&gt; -templatePath &lt;template file&gt; 
    -csProjPath &lt;.csproj file of your web site&gt; -dbOptionGroupName &lt;option group name&gt; -stackPolicyPath &lt;file with stack policy&gt</pre>

<dl>
  <dt>version</dt>
  <dd>
      Version of the code you're deploying. For example &quot;2.1.0&quot;. Each time you deploy a new version of your code,
      use a new version. The version doubles as the name of the code package in the S3 bucket, so make sure it is unique.
  </dd>

  <dt>stackName</dt>
  <dd>
      The set of servers, etc. you create with a template is called a stack. You can create a different set of servers
      by passing in a different stack name. For example, you could create a stack &quot;Test&quot; and another stack called
      &quot;Live&quot;.
  </dd>

  <dt>websiteDomain</dt>
  <dd>
      Domain of the web site. For example, &quot;mydomain.com&quot; for your Live stack, or &quot;test-domain.com&quot; for your Test stack.
  </dd>

  <dt>keyName</dt>
  <dd>
      Name of the key pair that you'll use to log into your EC2 instances. Remember that key pairs are tied to a region.
      To find a key pair name, click <i>Services</i> | <i>Key Pairs</i>.
  </dd>

  <dt>credentialsStoreName</dt>
  <dd>
      Name of the credentials store where you stored your credentials 
      <a href="#credentialsstore">earlier</a>.
  </dd>

  <dt>adminCidr</dt>
  <dd>
      You don't want everybody in the world to be able to try and log into your EC2 instances
      or database servers via SSMS.
      Here you pass the
      <a href="http://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing" target="_blank">CIDR</a>
      from which someone can log in. Typically, that would be the CIDR of your own machine
      (<a href="http://www.findmyip.org/" target="_blank">Your IP address</a> | 
      <a href="http://www.ipaddressguide.com/cidr#range" target="_blank">Convert IP to CIDR</a>).
  </dd>

  <dt>dbMasterUsername</dt>
  <dt>dbMasterUserPassword</dt>
  <dd>
      RDS only supports SQL Server Authentication. These are the username and password that will be able
      to access your new database server via SSMS, and that will be inserted into your web.config.
  </dd>

  <dt>bucketName</dt>
  <dd>
      S3 bucket where the code packages will be stored. This name must be unique across all S3 buckets
      hosted by AWS. To make sure a given S3 bucket name is available, create the S3 bucket yourself: click<i>Services</i> | <i>S3</i>.
  </dd>

  <dt>templatePath</dt>
  <dd>
      Path to the CloudFormation template to use. 
      You could use one of the 
      <a href="#solutioncomponents-template-nofailover">templates in the downloads</a>
      or use your own.
      <p>
          If you use your own template and it has 
          <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html" target="_blank">parameters</a>,
          be aware that the 
           <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/publish.ps1" target="_blank">Publish.ps1</a>
          script sets only a limited set of parameters (in the method <i>launch-stack</i>).
          All other parameters must be optional and/or have defaults.
      </p>
  </dd>

  <dt>csProjPath</dt>
  <dd>
      Path of the .csproj file of the web site you're deploying. The Publish.ps1 script will build the site in release mode,
      package up the code and store the package in the S3 bucket.
  </dd>

  <dt>dbOptionGroupName (optional)</dt>
  <dd>
      Name of the option group you created 
      <a href="#optiongroup">earlier</a> that has mirroring enabled. Only use this if you're 
      using a template that creates a SQL Server Standard Edition (or higher) database server
      (such as <a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/Template%20with%20SQL%20Server%20Express/Ec2RdsRoute54.template"
            target="_blank">this template</a>).
        <p>
            If you try to use such an option group with an engine that does not support mirroring, such as SQL Server Express or SQL Server Web Edition,
            CloudFormation will fail to create your stack.
        </p>
  </dd>

  <dt>stackPolicyPath (optional)</dt>
  <dd>
      File path of a <a href="#solutioncomponents-stackpolicy">stack policy</a> to protect for example your database during stack updates
      (<a href="https://github.com/mperdeck/AWS-articles/blob/master/4/Downloads/stackpolicy.txt" target="_blank">example</a>).
      If you do not use a stack policy, do not use this parameter.
  </dd>

<h3>7. Set nameservers</h3>

@@@@@@@@@@@@@@@@@@@@@@@

<h3>8. Copy data and schema from old database</h3>

@@@@@@@@@@@@@@@@@@@@@@@




<h2>Implementation notes</h2>

@@@@@@@@@@@@@@@@@@@@@@@




---------------------------------------
@@@@@@@@@@@@@@@@@@
pricing
multi-az








